CREATE PROCEDURE DBO.SANPP_RF_VALORIZACAO (
	@RF_CARACTERISTICA CHAR(20)
	,@DT_INICIAL DATETIME
	,@DT_FINAL DATETIME
	,@RETORNA_MSG CHAR(01) = 'N'
	,-- INDICA SE RETORNA MENSAGEM DE ERRO NA VARIÁVEL DE OUTPUT
	@MENSAGEM_ERRO VARCHAR(500) = '' OUTPUT -- MENSAGEM DE ERRO
	)
AS
BEGIN
	SET NOCOUNT ON

	/*** RF0888.PRC ***/
	DECLARE @DT_CALC DATETIME
		,@DT_UTIL DATETIME
		,@FLOAT0 FLOAT
		,@FLOAT1 FLOAT
		,@FLOAT100 FLOAT
		,@DT19000101 DATETIME
		,@DT19971231 DATETIME
		,@DT20000801 DATETIME
		,@PFPJ_APELIDO_EMPRESA VARCHAR(15)
		,@PFPJ_CUSTODIANTE VARCHAR(15)
		,@PFPJ_CORRENTISTA VARCHAR(15)
		,@ATV_CODIGO VARCHAR(15)
		,@ATV_AP CHAR(01)
		,@TIPO_ESTOQUE CHAR(02)
		,@ESTOQUE_ORI CHAR(02)
		,@TITULO_ID INT
		,@PFPJ_LOCAL_NEGOC VARCHAR(15)
		,@CD_CLFC_3068 INT
		,@CTB_CURVA CHAR(02)
		,@RF_DTLIQ DATETIME
		,@RF_BASE_CALC DATETIME
		,@CETIP_SELIC CHAR(01)
		,@RF_FCALC_IR CHAR(03)
		,-- 25/06/2010 -- @RF_FCALC_IR		CHAR(01)
		@RF_FCALC_IOFR CHAR(03)
		,@RF_TRIB_IR CHAR(01)
		,@RF_TRIB_IOF CHAR(01)
		,@IDX_CODIGO VARCHAR(15)
		,@TIT_VENCTO DATETIME
		,@TIT_EMISSAO DATETIME
		,@TIT_CUPOM FLOAT
		,@ATV_LOTE FLOAT
		,@ATV_FCVALORIZ CHAR(03)
		,@ATV_PRZ_PGJUROS INT
		,@FCALC_CUPOM CHAR(03)
		,@IDX_FCALC CHAR(03)
		,@IDX_TIPO CHAR(01)
		,@DIA_ANV CHAR(02)
		,@RFX_FCALC CHAR(03)
		,@IDX_PRE CHAR(01)
		,@RFX_PARTIDA DATETIME
		,@RFX_RESULTADO CHAR(03)
		,@IDX_GERENCIAL VARCHAR(15)
		,@IC_CEN_VCMT CHAR(01)
		,@IC_CEN_VCMT_AUX CHAR(01)
		,@SGL_MEDA VARCHAR(15)
		,@DT_ACABOU_CEN DATETIME
		,@ATV_RENDA CHAR(01)
		,@ATV_IDX_CUSTO VARCHAR(15)
		,@ATV_ISENTO_IR CHAR(01)
		,@IC_OPRC_NAO_PADR CHAR(01)
		,@ID_RPAC INT
		,@IDX_PC FLOAT
		,@DT_INIC_RPAC DATETIME
		,@DT_FIM_RPAC DATETIME
		,@DT_PROX_RPAC DATETIME
		,@V_PU_PMIO FLOAT
		,@DT_EVE DATETIME
		,@IC_EVE_CORC_TIT CHAR(01)
		,@V_PU_CORC FLOAT
		,@RFS_QTDE FLOAT
		,@RFS_QTDE_C FLOAT
		,@RFS_QTDE_V FLOAT
		,@RFS_FIN_C FLOAT
		,@RFS_FIN_V FLOAT
		,@RFS_PRINCIPAL FLOAT
		,@QTD_V_CTBL FLOAT
		,@PRINC_CTBL FLOAT
		,@RFS_TAXA_MEDIA FLOAT
		,@RFS_TAXA_MEDIA_U FLOAT
		,@RFS_PU_UTEIS FLOAT
		,@RFS_PU_CORRIDOS FLOAT
		,@RFS_PU_MERCADO FLOAT
		,@RFS_PU_UTEIS_ANT FLOAT
		,@RFS_PU_MERC_ANT FLOAT
		,@RFS_RESULTADO FLOAT
		,@RFS_IOF FLOAT
		,@RFS_IR FLOAT
		,@RFS_IR_ANT FLOAT
		,@RFS_IOFR FLOAT
		,@IR_ABERTURA FLOAT
		,@RFS_JUROS FLOAT
		,@RFS_JUROS_ANT FLOAT
		,@RFS_CORRECAO FLOAT
		,@RFS_CORRECAO_ANT FLOAT
		,@V_PU_CTBL FLOAT
		,@PGT_JUROS FLOAT
		,@PU_PGTO_JUROS FLOAT
		,@PRINCIPAL_ABERTURA FLOAT
		,@RFS_PROVISAO_DIF FLOAT
		,@RFS_PROVISAO FLOAT
		,@RFS_PROVISAO_ANT FLOAT
		,@RFS_PROVISAO_TRANSF FLOAT
		,@V_JURS_CTBL FLOAT
		,@V_CORC_CTBL FLOAT
		,@V_JURS_CTBL_ANTR FLOAT
		,@V_CORC_CTBL_ANTR FLOAT
		,@V_FATR_ACUD_UTES FLOAT
		,@V_FATR_ACUD_MERC FLOAT
		,@RFSC_VALOR FLOAT
		,@V_PZ_MDIO_CALD FLOAT
		,@V_DURT_CALD FLOAT
		,@V_DURT_CALD_VOLTA FLOAT
		,@FER_CHAVE VARCHAR(15)
		,@EH_FUNDO CHAR(01)
		,@PU_AQUIS FLOAT
		,@PMIO_AQUIS FLOAT
		,@DT_AQUIS DATETIME
		,@DT_PRIM_ANV DATETIME
		,@MERC_DT_AQUIS CHAR(01)
		,@RFS_PU_TIR FLOAT
		,@TIR_U FLOAT
		,@TIR_C FLOAT
		,@TIR_M FLOAT
		,@FIN_APROPRIACAO FLOAT
		,@FIN_PARTIDA FLOAT
		,@FIN_ABE_APROP FLOAT
		,@FIN_ABE_PARTIDA FLOAT
		,@QTDE_SALDO FLOAT
		,@FIN_TRUNCA CHAR(01)
		,@EH_RESERVA INT
		,@ERRO INT
		,@ERR_MSG VARCHAR(200)
		,@CORRECAO_AQUIS FLOAT
		,@VAR_AQUIS FLOAT
		,@DATA DATETIME
		,@EVE_JURS_AMTC CHAR(01)
		,@EVE_JURS_PCPL CHAR(01)
		,@EVE_JURS_DTBS CHAR(01)
		,@EVE_CORC_AMTC CHAR(01)
		,@EVE_CORC_PCPL CHAR(01)
		,@EVE_AMTC_PCPL CHAR(01)
		,@RFS_CORRECAO_PAGA FLOAT
		,@RFS_PGTO_DIA FLOAT
		,@PU_MEDIO_C FLOAT
		,@PU_MEDIO_U FLOAT
		,@V_PU_CTBL_ABERTURA FLOAT
		,@RFS_EVE_PRINCIPAL FLOAT
		,@RFS_CORRECAO_TEMP FLOAT
		,@DT_AQUIS_ANT DATETIME
		,@FL_DESCAP CHAR(1)
		,@FL_IDX_CONTABIL CHAR(1)
		,@PU_CURVA_AQUIS FLOAT
		,-- PU DA CURVA NA DATA DE AQUISICAO - UTILIZADO PARA CALCULO DO AGIO/DESAGIO
		@PU_CURVA_ATUAL FLOAT
		,-- PU DA CURVA NA DATA DE CALCULO
		@RFS_PRINCIPAL_ANT FLOAT
		,-- Liana  - 14/07/2010
		@VDT_DTCORTE_CEN_VCMT DATETIME
		,@RFM_DTERMO DATETIME
		,@RFM_PU_NEG_TERM FLOAT
		,@POS_DIA_CENARIO INT
		,@RFS_CORRECAO_AUX FLOAT
		,@RFS_PU_UTEIS_AUX FLOAT
		,@RFS_PU_CORRIDOS_AUX FLOAT
		,@RFS_PU_MERCADO_AUX FLOAT
		,@RFSC_VALOR_AUX FLOAT
		,@TIR_M_AUX FLOAT
		,@DT_ACABOU_CEN_AUX DATETIME
		,@V_PZ_MDIO_CALD_AUX FLOAT
		,@V_DURT_CALD_AUX FLOAT
		,@RFM_DT_INI CHAR(01)
		,-- Liana - 12/01/2010
		@FL_ARRED CHAR(1)
		,-- Aluisio 09/07/2010
		@TRUNCA SMALLINT
		,-- Aluisio - 09/06/2010
		@ARREDONDA SMALLINT
		,-- Aluisio - 09/06/2010
		@PU_CASAS SMALLINT
		,-- Aluisio - 09/06/2010
		@PU_ARRED SMALLINT
		,-- Aluisio - 09/06/2010
		@DT_PRIM_AMORT DATETIME
		,@RF_AGENTE CHAR(15)
		,-- Liana - 09/08/2010
		-- Liana - 26/11/2010
		@RFS_QTDE_V_ANT FLOAT
		,@RFS_QTDE_ANT FLOAT
		,@RFS_QTDE_C_ANT FLOAT
		,@RFS_JUROS_ANT_AUX FLOAT
		,@RFS_CORRECAO_ANT_AUX FLOAT
		,@PU_JUROS_PGTO_DIA_ANT FLOAT
		,@PU_JUROS_PGTO_DIA FLOAT
		,@CORTE_IOF DATETIME
		,@VCH_TP_F_J CHAR(01)
		,-- TIPO DE PESSOA -  MARCELO GONZAGA 26/11/2013
		-- KUBA - 21/11/2016
		@DT_REF_PG DATETIME
		,@DT_REF_PG_INI DATETIME
		,@RF_CARACT_00 CHAR(20)
		,@FIN_ABERTURA_00 FLOAT
		,@TIR_ANT_00 FLOAT
		,@DT_ANT DATETIME
		,@RFS_QTDE_C_00 FLOAT
		,@RFS_FIN_C_00 FLOAT
		,@QTDE_ANT_00 FLOAT
		,@TIR_U_ANT_00 FLOAT
		,@TIR_C_ANT_00 FLOAT
		,@FIN_ABERTURA FLOAT
		,@RFS_PU_C_ABERTURA_00 FLOAT
		,@RFS_PU_U_ABERTURA_00 FLOAT
		,@RFS_CORRECAO_00 FLOAT
		,@RFS_PU_MERCADO_00 FLOAT
		,@RFSC_VALOR_00 FLOAT
		,@TIR_M_00 FLOAT
		,@DT_ACABOU_CEN_00 DATETIME
		,@V_PZ_MDIO_CALD_00 FLOAT
		,@V_DURT_CALD_00 FLOAT
		,@FL_TIR_RECALCULADA VARCHAR(1)
		,
		-- KUBA - 03/02/2017
		@V_PU_AMTC_DIA FLOAT
		,@V_RFM_PU_PAGTO_JUROS FLOAT
		,--REGICAU - 11/12/2017
		@V_DT_TRANSF_CARTADM VARCHAR(10)
		,--REGICAU - 11/12/2017
		@V_TRANSF_CARTADM CHAR(1)
		,--REGICAU - 11/12/2017
		@CD_T_OPRC INT
		,-- MARCIO 20/05/2019
		@V_PRIM_CALCULO CHAR(1)
		,-- MARCIO 20/05/2019 - VERIFICA SE É O PRIMEIRO CALCULO 
		@V_SEGU_CALCULO CHAR(1)
		,-- MARCIO 20/05/2019 - VERIFICA SE É O SEGUNDO CALCULO, FAZER INVERSÃO DE VALOR DE RFS_QTDE_C PARA RFS_QTDE
		@QTD_DIAS_CALC INT
		,-- MARCIO 20/05/2019 - PARAMETRO DE QTDE DE DIAS PARA CALCULO DE TRANS DE CUSTODIA 
		@DT_CALC_INI DATETIME

	SELECT @V_PRIM_CALCULO = 'S' -- MARCIO 20/05/2019

	SELECT @V_SEGU_CALCULO = 'N' -- MARCIO 20/05/2019

	SELECT @DT_CALC = @DT_INICIAL
		,@FLOAT0 = CONVERT(FLOAT, 0)
		,@FLOAT1 = CONVERT(FLOAT, 1)
		,@FLOAT100 = CONVERT(FLOAT, 100)
		,@DT19000101 = CONVERT(DATETIME, '19000101')
		,@DT19971231 = CONVERT(DATETIME, '19971231')
		,@DT20000801 = CONVERT(DATETIME, '20000801')
		,@EH_FUNDO = 'N'
		,@MERC_DT_AQUIS = 'S'
		,@IC_CEN_VCMT = 'N'
		,@IC_CEN_VCMT_AUX = 'N'
		,@FIN_TRUNCA = 'N'
		,@ERRO = - 1
		,@FL_DESCAP = 'N'
		,@FL_IDX_CONTABIL = 'N'
		,@EVE_JURS_AMTC = '1'
		,-- JUROS SOBRE AMORTIZACAO
		@EVE_JURS_PCPL = '2'
		,-- JUROS SOBRE PRINCIPAL
		@EVE_CORC_PCPL = '3'
		,-- ATUALIZACAO SOBRE PRINCIPAL
		@EVE_AMTC_PCPL = '4'
		,-- AMORTIZACAO DO PRINCIPAL
		@EVE_CORC_AMTC = '5'
		,-- ATUALIZACAO SOBRE AMORTIZACAO
		@EVE_JURS_DTBS = '6'
		,-- JUROS SOBRE PRINCIPAL CORRIG. DESDE A DATABASE - DESENV PROJ. CRI-LH
		@RFM_DT_INI = ''
		,-- Liana - 12/01/2010
		@FL_ARRED = 'N'
		,-- Aluisio - 09/06/2010
		@TRUNCA = 1
		,-- Aluisio - 09/06/2010
		@ARREDONDA = 0
		,-- Aluisio - 09/06/2010
		@PU_JUROS_PGTO_DIA_ANT = 0
		,-- Liana - 30/12/2010
		@PU_JUROS_PGTO_DIA = 0
		,@V_PU_AMTC_DIA = 0 -- KUBA - 07/02/2017

	SELECT @PU_AQUIS = @FLOAT0
		,@PMIO_AQUIS = @FLOAT0
		,@RFS_PU_C_ABERTURA_00 = @FLOAT0
		,-- KUBA - 02/12/2016
		@FIN_ABERTURA_00 = @FLOAT0 -- KUBA - 02/12/2016

	--11/12/2006
	SELECT @RFS_CORRECAO = @FLOAT0
		,@RFS_JUROS = @FLOAT0
		,@RFS_PU_UTEIS = @FLOAT0
		,@RFS_PU_CORRIDOS = @FLOAT0
		,@RFS_PU_MERCADO = @FLOAT0
		,@DT_REF_PG_INI = '19000101'

	-- BUSCA OS DADOS DO TITULO E DA OPERACAO
	SELECT @PFPJ_APELIDO_EMPRESA = PFPJ_APELIDO_EMPRESA
		,@PFPJ_CUSTODIANTE = PFPJ_CUSTODIANTE
		,@PFPJ_CORRENTISTA = PFPJ_CORRENTISTA
		,@ATV_CODIGO = ATV_CODIGO
		,@ATV_AP = ATV_AP
		,@TIPO_ESTOQUE = TIPO_ESTOQUE
		,@ESTOQUE_ORI = TIPO_ESTOQUE
		,@TITULO_ID = TITULO_ID
		,@PFPJ_LOCAL_NEGOC = PFPJ_LOCAL_NEGOC
		,@CD_CLFC_3068 = ISNULL(CD_CLFC_3068, 0)
		,@CTB_CURVA = ISNULL(CTB_CURVA, '')
		,@RF_BASE_CALC = ISNULL(RF_BASE_CALC, @DT19000101)
		,@RF_DTLIQ = RF_DTLIQ
		,@CETIP_SELIC = CASE 
			WHEN PFPJ_LOCAL_NEGOC = 'SELIC'
				THEN 'S'
			ELSE 'C'
			END
		,@RF_FCALC_IR = RF_FCALC_IR
		,@RF_FCALC_IOFR = RF_FCALC_IOFR
		,@RF_TRIB_IR = RF_TRIB_IR
		,@RF_TRIB_IOF = RF_TRIB_IOF
		,@DT_CALC = CASE 
			WHEN RF_EMISSAO > @DT_CALC
				THEN RF_EMISSAO
			ELSE @DT_CALC
			END
		,@TIT_VENCTO = RF_VENCTO
		,@RF_AGENTE = RTRIM(ISNULL(RF_AGENTE, '')) -- Liana - 09/08
	FROM RENDA_FIXA(NOLOCK)
	WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA

	IF @@ROWCOUNT = 0
	BEGIN
		SELECT @ERR_MSG = @RF_CARACTERISTICA + ': NAO EXISTE RENDA_FIXA.' + ' DATA: ' + CONVERT(CHAR(10), @DT_CALC, 103)

		IF @RETORNA_MSG <> 'S'
			RAISERROR 70001 @ERR_MSG
		ELSE
			SELECT @MENSAGEM_ERRO = @ERR_MSG

		RETURN
	END

	IF @CD_CLFC_3068 > 0
		SELECT @ESTOQUE_ORI = TIPO_ESTOQUE
		FROM RENDA_FIXA(NOLOCK)
		WHERE CD_CLFC_3068 = @CD_CLFC_3068
			AND TIPO_ESTOQUE <> '09'

	-- OBTEM TIPO DE PESSOA - MARCELO GONZAGA 26/11/2013
	SELECT @VCH_TP_F_J = TP_F_J
	FROM PF_PJ T1(NOLOCK)
		,TIPO_PFPJ T2(NOLOCK)
	WHERE T1.PFPJ_APELIDO = @PFPJ_APELIDO_EMPRESA
		AND T1.TP_CODIGO = T2.TP_CODIGO

	-- VERIFICA A POSICAO PARA FERIADOS
	SELECT @FER_CHAVE = @PFPJ_APELIDO_EMPRESA

	EXEC SIAN_EMPRESA_DO_GRUPO @FER_CHAVE OUTPUT
		,@PFPJ_CUSTODIANTE
		,@PFPJ_CORRENTISTA
		,0

	-- BUSCA O DIA UTIL ANTERIOR
	SELECT @DT_UTIL = @DT_CALC

	EXEC SIAN_SP_RESERVA_ANTERIOR @FER_CHAVE
		,'A'
		,@DT_UTIL OUTPUT
		,0

	-- BUSCAR DADOS DA INDEXACAO
	SELECT @RFX_FCALC = CASE 
			WHEN @IC_OPRC_NAO_PADR = 'S'
				THEN @RFX_FCALC
			ELSE RFX_FCALC
			END
		,@RFX_PARTIDA = RFX_PARTIDA
		,@RFX_RESULTADO = RFX_RESULTADO
		,@IDX_GERENCIAL = IDX_GERENCIAL
		,@SGL_MEDA = ISNULL(SGL_MEDA, '')
		,@IDX_PC = CASE 
			WHEN RFX_PERC = 0
				THEN @FLOAT100
			ELSE RFX_PERC
			END
		,@IC_CEN_VCMT = ISNULL(IC_CEN_VCMT, 'N')
		,@IC_CEN_VCMT_AUX = ISNULL(IC_CEN_VCMT, 'N')
	FROM RF_INDEXACAO(NOLOCK)
	WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA

	IF @@ROWCOUNT = 0
	BEGIN
		SELECT @ERR_MSG = @RF_CARACTERISTICA + ': NAO EXISTE RF_INDEXACAO: ' + RTRIM(@IDX_CODIGO) + '. DATA: ' + CONVERT(CHAR(10), @DT_CALC, 103)

		IF @RETORNA_MSG <> 'S'
			RAISERROR 70001 @ERR_MSG
		ELSE
			SELECT @MENSAGEM_ERRO = @ERR_MSG

		RETURN
	END

	-- SE A DATA INICIAL FOR ANTERIOR A PARTIDA, INICIA COM A PARTIDA
	IF @DT_CALC < @RFX_PARTIDA
		SELECT @DT_CALC = @RFX_PARTIDA

	-- BUSCA A DATA DE AQUISICAO
	--PAÇOCA - 02/02/2010
	IF @TIPO_ESTOQUE = '08'
	BEGIN
		SELECT @DT_AQUIS = RFM_DATA
			,@PU_AQUIS = RFM_PU
			,@PMIO_AQUIS = ISNULL(V_PU_PMIO, @FLOAT0)
			,@RFM_DTERMO = RFM_DTERMO
			,@RFM_PU_NEG_TERM = RFM_PU
			,@RFM_DT_INI = RFM_DT
		FROM RF_MOVIMENTACAO A(NOLOCK)
		WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
			AND RFM_OK = 'S'
			AND RFM_DATA IN (
				SELECT MIN(RFM_DATA)
				FROM RF_MOVIMENTACAO
				WHERE RF_CARACTERISTICA = A.RF_CARACTERISTICA
				)

		SELECT @DT_AQUIS_ANT = @DT_AQUIS

		IF @DT_FINAL > @RFM_DTERMO
		BEGIN
			SET @DT_FINAL = @RFM_DTERMO
		END
				--		SELECT @DT_AQUIS '@DT_AQUIS', @PU_AQUIS '@PU_AQUIS', @PMIO_AQUIS '@PMIO_AQUIS', @DT_AQUIS_ANT '@DT_AQUIS_ANT', @RFM_DTERMO '@RFM_DTERMO', @RFM_PU_NEG_TERM '@RFM_PU_NEG_TERM'
	END
	ELSE IF @PFPJ_APELIDO_EMPRESA = 'SAFRABM'
		AND @ATV_CODIGO = 'CRI'
		AND @RF_AGENTE = 'SAFRA SEC'
	BEGIN
		SELECT @DT_AQUIS = RFM_DATA
			,@DT_AQUIS_ANT = RFM_DATA
			,@PMIO_AQUIS = SUM(ISNULL(V_PU_PMIO, @FLOAT0) * RFM_QTDE) / SUM(RFM_QTDE)
		FROM RF_MOVIMENTACAO(NOLOCK)
		WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
			AND RFM_OK = 'S'
			AND RFM_DATA < @DT_CALC
			AND RFM_QTDE > 0
			AND (
				(
					@ATV_AP = 'A'
					AND RFM_DT = 'A'
					)
				OR (
					@ATV_AP = 'P'
					AND RFM_DT = 'C'
					)
				)
		GROUP BY RFM_DATA
		HAVING RFM_DATA = MAX(RFM_DATA)

		IF @@ROWCOUNT = 0
		BEGIN
			SELECT @DT_AQUIS = RFM_DATA
				,@DT_AQUIS_ANT = RFM_DATA
				,@PU_AQUIS = SUM(RFM_FINANCEIRO) / SUM(RFM_QTDE)
				,@PMIO_AQUIS = SUM(ISNULL(V_PU_PMIO, @FLOAT0) * RFM_QTDE) / SUM(RFM_QTDE)
			FROM RF_MOVIMENTACAO(NOLOCK)
			WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
				AND RFM_OK = 'S'
				AND RFM_DATA <= @DT_CALC
				AND RFM_QTDE > 0
				AND (
					(
						@ATV_AP = 'A'
						AND RFM_DT = 'A'
						)
					OR (
						@ATV_AP = 'P'
						AND RFM_DT = 'C'
						)
					)
			GROUP BY RFM_DATA
				,RF_CARACTERISTICA
			HAVING RFM_DATA = MAX(RFM_DATA)
				AND RF_CARACTERISTICA = MIN(RF_CARACTERISTICA)

			--15/01/2007 - Cleber Drobnicki - Problemas ao buscar a aquisicao
			IF @@ROWCOUNT = 0
			BEGIN
				SELECT @DT_AQUIS = RFM_DATA
					,@PU_AQUIS = RFM_PU
					,@PMIO_AQUIS = 0.0
				FROM RF_MOVIMENTACAO(NOLOCK)
				WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
					AND RFM_OK = 'S'
					AND RFM_DATA <= @DT_CALC
					AND (
						(
							@ATV_AP = 'A'
							AND RFM_DT = 'A'
							)
						OR (
							@ATV_AP = 'P'
							AND RFM_DT = 'C'
							)
						)

				IF @@ROWCOUNT = 0
				BEGIN
					SELECT @ERR_MSG = @RF_CARACTERISTICA + ': PROBLEMAS AO BUSCAR AQUISICAO CRI.' + ' DATA: ' + CONVERT(CHAR(10), @DT_CALC, 103)

					IF @RETORNA_MSG <> 'S'
						RAISERROR 70001 @ERR_MSG
					ELSE
						SELECT @MENSAGEM_ERRO = @ERR_MSG

					RETURN
				END
			END
		END
		ELSE
		BEGIN
			-- PARA CRI NA CARTEIRA DA SAFRABM BUSCAMOS COMO PU DE AQUIS. O PU MEDIA NO DIA DA ULTIMA COMPRA
			SELECT @PU_AQUIS = RFS_PU_CORRIDOS
			FROM RF_SALDOS(NOLOCK)
			WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
				AND RFS_DATA = @DT_AQUIS
		END
	END
	ELSE
	BEGIN
		-- KUBA - 22/11/2016 - CALCULA DATA DE AQUISIÇÃO COMO A ÚLTIMA DATA EM QUE A QUANTIDADE DE ABERTURA É 0 E EXISTE MOVIMENTAÇÃO. (ABERTURA DE NOVA POSIÇÃO)
		SELECT @DT_AQUIS = MAX(RFS_DATA)
		FROM (
			SELECT RFS_DATA
			FROM RF_SALDOS
			WHERE RFS_QTDE = 0
				AND RF_CARACTERISTICA = @RF_CARACTERISTICA
				AND RFS_DATA <= @DT_CALC
			
			UNION
			
			SELECT RFS_DATA
			FROM GERENCIAL_F_HIST.DBO.RF_SALDOS
			WHERE RFS_QTDE = 0
				AND RF_CARACTERISTICA = @RF_CARACTERISTICA
				AND RFS_DATA <= @DT_CALC
			
			UNION
			
			SELECT CONVERT(DATETIME, '19000101')
			) SD

		IF @DT_AQUIS = CONVERT(DATETIME, '19000101')
		BEGIN
			SELECT @DT_AQUIS = (
					SELECT MIN(RFM_DATA)
					FROM (
						SELECT RF_CARACTERISTICA
							,RFM_DATA
							,RFM_OK
							,RFM_QTDE
							,RFM_DT
						FROM RF_MOVIMENTACAO
						WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
							AND RFM_OK = 'S'
						) A
					WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
						AND RFM_OK = 'S'
						AND RFM_QTDE > 0
						AND (
							@ATV_AP = 'A'
							AND RFM_DT = 'A'
							)
						OR (
							@ATV_AP = 'P'
							AND RFM_DT = 'C'
							)
					)

			IF @@ROWCOUNT = 0
			BEGIN
				SELECT @DT_AQUIS = (
						SELECT MIN(RFM_DATA)
						FROM (
							SELECT RF_CARACTERISTICA
								,RFM_DATA
								,RFM_OK
								,RFM_QTDE
								,RFM_DT
							FROM RF_MOVIMENTACAO
							WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
								AND RFM_OK = 'S'
							) A
						WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
							AND RFM_OK = 'S'
							AND (
								@ATV_AP = 'A'
								AND RFM_DT = 'A'
								)
							OR (
								@ATV_AP = 'P'
								AND RFM_DT = 'C'
								)
						)
			END
		END

		-- KUBA 10/01/2017
		SELECT @DT_REF_PG_INI = @DT_AQUIS

		-- CALCULA PU DE AQUISICAO E PREMIO DE AQUISICAO
		SELECT @PU_AQUIS = SUM(RFM_FINANCEIRO) / SUM(RFM_QTDE)
			,@PMIO_AQUIS = SUM(ISNULL(V_PU_PMIO, @FLOAT0) * RFM_QTDE) / SUM(RFM_QTDE)
		FROM RF_MOVIMENTACAO(NOLOCK)
		WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
			AND RFM_OK = 'S'
			AND RFM_DATA >= @DT_AQUIS
			AND RFM_DATA <= @DT_CALC
			AND RFM_QTDE > 0
			AND (
				(
					@ATV_AP = 'A'
					AND RFM_DT = 'A'
					)
				OR (
					@ATV_AP = 'P'
					AND RFM_DT = 'C'
					)
				)
		GROUP BY RFM_DATA

		IF @@ROWCOUNT = 0
		BEGIN
			SELECT @PU_AQUIS = @FLOAT0
				,@PMIO_AQUIS = @FLOAT0
		END

		--25/11/2005
		--TRATAMENTO PARA SAFRABM COMPRANDO SAFRALEASE CART. ESTA OPER. CARACTERIZA-SE
		--COMO UMA EMISSAO, PORTANTO, OS PU'S DEVEM SER IGUAIS (SAFRALEASE CART E BS).
		SELECT @DT_AQUIS = RFM_DATA
			,@PU_AQUIS = MAX(RFM_PU)
			,@PMIO_AQUIS = ISNULL(MAX(V_PU_PMIO), @FLOAT0)
		FROM RF_MOVIMENTACAO(NOLOCK)
		WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
			AND RFM_OK = 'S'
			AND RFM_DATA <= @DT_CALC
			AND (
				(
					@ATV_AP = 'A'
					AND RFM_DT = 'A'
					)
				)
			AND PFPJ_APELIDO_CLIENTE = 'SAFRALEASE CART'
		GROUP BY RFM_DATA
		HAVING RFM_DATA = MAX(RFM_DATA)

		SELECT @DT_AQUIS_ANT = @DT_AQUIS -- PARA A POSICAO DE CLIENTE
	END

	-- -- 	-- KUBA - 01/12/2016 - RECUPERA ESTOQUE TOTAL
	-- 	SELECT @RF_CARACT_00 =  B.RF_CARACTERISTICA
	-- 	FROM RENDA_FIXA A INNER JOIN
	-- 		 RENDA_FIXA B ON A.CD_CLFC_3068 = B.CD_CLFC_3068
	-- 	WHERE A.RF_CARACTERISTICA = @RF_CARACTERISTICA AND
	-- 		  B.CD_CLFC_3068 <> 0 AND
	-- 		  B.TIPO_ESTOQUE = '00' AND A.RF_OK = 'S' AND B.RF_OK = 'S'
	--SELECT 'BICUDO', @RF_CARACT_00 RF_CARACT_00
	SELECT @CD_CLFC_3068 = 0

	SELECT @CD_CLFC_3068 = ISNULL(CD_CLFC_3068, 0)
	FROM RENDA_FIXA(NOLOCK)
	WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA

	SELECT @RF_CARACT_00 = @RF_CARACTERISTICA

	--	SELECT @CD_CLFC_3068 CD_CLFC_3068
	IF @CD_CLFC_3068 > 0
	BEGIN
		SELECT @RF_CARACT_00 = RF_CARACTERISTICA
		FROM RENDA_FIXA(NOLOCK)
		WHERE CD_CLFC_3068 = @CD_CLFC_3068
			AND TIPO_ESTOQUE <> '09'
	END

	-- VERIFICA SE EH UMA OPERACAO NAO PADRONIZADA
	SELECT @ATV_ISENTO_IR = ATV_ISENTO_IR
		,@IC_OPRC_NAO_PADR = ISNULL(IC_OPRC_NAO_PADR, 'N')
	FROM RF_MERCADORIA(NOLOCK)
	WHERE ATV_CODIGO = @ATV_CODIGO

	IF @@ROWCOUNT = 0
	BEGIN
		SELECT @ERR_MSG = @RF_CARACTERISTICA + ': NAO EXISTE RF_MERCADORIA: ' + RTRIM(@ATV_CODIGO) + '. DATA: ' + CONVERT(CHAR(10), @DT_CALC, 103)

		IF @RETORNA_MSG <> 'S'
			RAISERROR 70001 @ERR_MSG
		ELSE
			SELECT @MENSAGEM_ERRO = @ERR_MSG

		RETURN
	END

	-- BUSCA OS DADOS DO TITULO
	IF @IC_OPRC_NAO_PADR = 'S'
	BEGIN
		IF @DT_CALC > @TIT_VENCTO
			SELECT @DATA = @TIT_VENCTO
		ELSE
			SELECT @DATA = @DT_CALC

		SELECT @IDX_CODIGO = B.IDX_CODIGO
			,@TIT_VENCTO = B.DT_VCMT
			,@TIT_EMISSAO = A.TIT_EMISSAO
			,@TIT_CUPOM = B.V_TXA_RPAC
			,@ATV_LOTE = A.ATV_LOTE
			,@ATV_FCVALORIZ = B.ATV_FCVALORIZ
			,@ATV_PRZ_PGJUROS = @FLOAT0
			,@ID_RPAC = B.ID_RPAC
			,@IDX_PC = B.IDX_PC
			,@DT_INIC_RPAC = B.DT_INIC_RPAC
			,@DT_FIM_RPAC = B.DT_FIM_RPAC
			,@DT_PROX_RPAC = B.DT_FIM_RPAC
			,@V_PU_PMIO = B.V_PU_PMIO
			,@RFX_FCALC = B.FC_JUROS
			,@RF_BASE_CALC = B.RF_BASE_CALC
			,@IC_EVE_CORC_TIT = ISNULL(B.IC_EVE_CORC_TIT, 'N')
			,@V_PU_CORC = ISNULL(B.V_PU_CORC, 0)
		FROM RF_TITULO A(NOLOCK)
			,SANT643_RF_REPAC_TITULO B(NOLOCK)
		WHERE A.TITULO_ID = @TITULO_ID
			AND A.TITULO_ID = B.TITULO_ID
			AND @DATA BETWEEN B.DT_INIC_RPAC
				AND B.DT_FIM_RPAC

		IF @@ROWCOUNT = 0
		BEGIN
			SELECT @ERR_MSG = @RF_CARACTERISTICA + ': NAO EXISTE REPACTUACAO. TITULO_ID: ' + RTRIM(CONVERT(CHAR, @TITULO_ID)) + '. DATA: ' + CONVERT(CHAR(10), @DT_CALC, 103)

			IF @RETORNA_MSG <> 'S'
				RAISERROR 70001 @ERR_MSG
			ELSE
				SELECT @MENSAGEM_ERRO = @ERR_MSG

			RETURN
		END

		-- Somente para titulos que NÃO são calculo manual (RFX_RESULTADO = '006')
		-- By Charlie - 10/06/2019
		IF NOT EXISTS (
				SELECT 1
				FROM RF_INDEXACAO
				WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
					AND RFX_RESULTADO = '006'
				)
		BEGIN
			-- Por causa do descasamento da data de vencimento com a data de liquidação do evento
			-- a valorização tem que usar como vencimento o último DT_EVE dos fluxos
			-- By Charlie - 18/06/2015
			IF EXISTS (
					SELECT 1
					FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
					WHERE TITULO_ID = @TITULO_ID
						AND ID_RPAC = @ID_RPAC
					)
			BEGIN
				SELECT @TIT_VENCTO = MAX(DT_EVE)
				FROM SANT644_RF_AGENDA_EVENTO
				WHERE TITULO_ID = @TITULO_ID
					AND ID_RPAC = @ID_RPAC
			END
		END

		-- SE A DATA INICIAL DE REPACTUACAO ESTIVER ENTRE O DATA UTIL ANTERIOR E A DATA DE CALCULO
		-- E EXISTIR UM PERIODO ANTERIOR ONDE A DATA DE VENCIMENTO DO TITULO SEJA A DATA INICIAL
		-- DESTE PERIODO, ASSUMIR OS DADOS ANTERIORES PARA CALCULAR UMA NOVA TIR
		-- ESTE CRITERIO SO EH VALIDO SE A AQUISICAO FOI FEITA ATE A DATA DE REPACTUACAO.
		IF @DT_INIC_RPAC > @DT_UTIL
			AND @DT_INIC_RPAC <= @DT_CALC
			AND @DT_AQUIS < @DT_INIC_RPAC
		BEGIN
			IF EXISTS (
					SELECT *
					FROM SANT643_RF_REPAC_TITULO(NOLOCK)
					WHERE TITULO_ID = @TITULO_ID
						AND
						-- DT_VCMT		=	@DT_INIC_RPAC	AND
						@DT_UTIL BETWEEN DT_INIC_RPAC
							AND DT_FIM_RPAC
					)
				-- LIGIA MUTO - 27/08/2009
				-- ALTERAÇÃO: TROCA DA VARIÁVEL @DT_UTIL POR @DT_CALC
				-- PQ QUANDO A OPERAÇÃO TINHA REPACTUAÇÃO A VALORIZAÇÃO DE APENAS UM DIA
				-- PEGAVA A TAXA ERRADA POR CAUSA DA DATA DE VENCIMENTO ERRADA
				SELECT @IDX_CODIGO = B.IDX_CODIGO
					,@TIT_VENCTO = B.DT_VCMT
					,@TIT_EMISSAO = A.TIT_EMISSAO
					,@TIT_CUPOM = B.V_TXA_RPAC
					,@ATV_LOTE = A.ATV_LOTE
					,@ATV_FCVALORIZ = B.ATV_FCVALORIZ
					,@ATV_PRZ_PGJUROS = @FLOAT0
					,@ID_RPAC = B.ID_RPAC
					,@IDX_PC = B.IDX_PC
					,@DT_INIC_RPAC = B.DT_INIC_RPAC
					,@DT_FIM_RPAC = B.DT_FIM_RPAC
					,@DT_PROX_RPAC = B.DT_FIM_RPAC
					,@V_PU_PMIO = B.V_PU_PMIO
					,@RFX_FCALC = B.FC_JUROS
					,@RF_BASE_CALC = B.RF_BASE_CALC
					,@IC_EVE_CORC_TIT = ISNULL(B.IC_EVE_CORC_TIT, 'N')
					,@V_PU_CORC = ISNULL(B.V_PU_CORC, 0)
				FROM RF_TITULO A(NOLOCK)
					,SANT643_RF_REPAC_TITULO B(NOLOCK)
				WHERE A.TITULO_ID = @TITULO_ID
					AND A.TITULO_ID = B.TITULO_ID
					AND @DT_CALC BETWEEN B.DT_INIC_RPAC
						AND B.DT_FIM_RPAC

			-- Somente para titulos que NÃO são calculo manual (RFX_RESULTADO = '006')
			-- By Charlie - 10/06/2019
			IF NOT EXISTS (
					SELECT 1
					FROM RF_INDEXACAO
					WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
						AND RFX_RESULTADO = '006'
					)
			BEGIN
				-- Por causa do descasamento da data de vencimento com a data de liquidação do evento
				-- a valorização tem que usar como vencimento o último DT_EVE dos fluxos
				-- By Charlie - 18/06/2015
				IF EXISTS (
						SELECT 1
						FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
						WHERE TITULO_ID = @TITULO_ID
							AND ID_RPAC = @ID_RPAC
						)
				BEGIN
					SELECT @TIT_VENCTO = MAX(DT_EVE)
					FROM SANT644_RF_AGENDA_EVENTO
					WHERE TITULO_ID = @TITULO_ID
						AND ID_RPAC = @ID_RPAC
				END
			END
		END

		-- A REPACTUACAO SEMPRE EXPIRA NA PROXIMA RESERVA
		EXEC SIAN_SP_PROXIMA_RESERVA 'A'
			,@FER_CHAVE
			,@DT_FIM_RPAC OUTPUT
			,0

		-- SE EXISTIR PERIODO POSTERIOR, AJUSTAR A DATA DA PROXIMA REPACTUACAO
		IF EXISTS (
				SELECT ID_RPAC
				FROM SANT643_RF_REPAC_TITULO(NOLOCK)
				WHERE TITULO_ID = @TITULO_ID
					AND ID_RPAC > @ID_RPAC
				)
		BEGIN
			SELECT @DT_PROX_RPAC = DATEADD(Day, 1, @DT_PROX_RPAC)
		END

		-- SE O PROXIMO ID FOR CORRECAO, BUSCA A DATA DA PROXIMA REPACTUACAO
		IF (
				SELECT IC_EVE_CORC_TIT
				FROM SANT643_RF_REPAC_TITULO(NOLOCK)
				WHERE TITULO_ID = @TITULO_ID
					AND ID_RPAC = @ID_RPAC + 1
				) = 'S'
		BEGIN
			-- BUSCA A DATA INICIAL DA PROXIMA REPACTUACAO OU O VENCTO DO TITULO
			SELECT @DT_PROX_RPAC = DT_INIC_RPAC
			FROM SANT643_RF_REPAC_TITULO(NOLOCK)
			WHERE TITULO_ID = @TITULO_ID
				AND ID_RPAC = (
					SELECT MIN(ID_RPAC)
					FROM SANT643_RF_REPAC_TITULO(NOLOCK)
					WHERE TITULO_ID = @TITULO_ID
						AND ID_RPAC > @ID_RPAC
						AND IC_EVE_CORC_TIT = 'N'
					)

			IF @@ROWCOUNT = 0
				SELECT @DT_PROX_RPAC = @TIT_VENCTO
		END
	END
	ELSE
	BEGIN
		SELECT @IDX_CODIGO = IDX_CODIGO
			,@TIT_VENCTO = TIT_VENCTO
			,@TIT_EMISSAO = TIT_EMISSAO
			,@TIT_CUPOM = ESP_CUPOM
			,@ATV_LOTE = ATV_LOTE
			,@ATV_FCVALORIZ = ATV_FCVALORIZ
			,@ATV_PRZ_PGJUROS = ATV_PRZ_PGJUROS
			,@ID_RPAC = @FLOAT1
			,@DT_INIC_RPAC = TIT_EMISSAO
			,@DT_FIM_RPAC = TIT_VENCTO
			,@DT_PROX_RPAC = TIT_VENCTO
			,@V_PU_PMIO = @FLOAT0
		FROM RF_TITULO(NOLOCK)
		WHERE TITULO_ID = @TITULO_ID

		IF @@ROWCOUNT = 0
		BEGIN
			SELECT @ERR_MSG = @RF_CARACTERISTICA + ': NAO EXISTE RF_TITULO. TITULO_ID: ' + RTRIM(CONVERT(CHAR, @TITULO_ID)) + '. DATA: ' + CONVERT(CHAR(10), @DT_CALC, 103)

			IF @RETORNA_MSG <> 'S'
				RAISERROR 70001 @ERR_MSG
			ELSE
				SELECT @MENSAGEM_ERRO = @ERR_MSG

			RETURN
		END
	END

	-- SE A DATA FINAL SOLICITADA PARA CALCULO FOR MAIOR QUE A DATA DE LIQUIDACAO
	-- DO TITULO, CALCULA ATE A MENOR DATA
	IF @DT_FINAL > @RF_DTLIQ
		SELECT @DT_FINAL = @RF_DTLIQ

	-- VERIFICA A FORMA DE CALCULO DO CUPOM
	SELECT @FCALC_CUPOM = CASE 
			WHEN IDX_TIPO = 'M'
				AND @TIT_EMISSAO > @DT20000801
				THEN '033'
			WHEN IDX_TIPO = 'M'
				OR (
					IDX_TIPO = 'I'
					AND @CETIP_SELIC = 'S'
					)
				THEN '013'
			ELSE @RFX_FCALC
			END
		,@IDX_FCALC = IDX_FCALC
		,@IDX_PRE = IDX_PRE
		,@IDX_TIPO = IDX_TIPO
		,@DIA_ANV = RIGHT('0' + CONVERT(VARCHAR, DIA_ANV), 2)
	FROM INDEXADOR(NOLOCK)
	WHERE IDX_CODIGO = @IDX_CODIGO

	--DANILO 18/12/2006: Para Indexadores PRE e que tenham pagamento de Juros (NTN-F), forma do calculo do CUPOM deve ser 013
	IF @IDX_PRE <> 'N'
		AND @ATV_FCVALORIZ = '004'
		SELECT @FCALC_CUPOM = '013'

	-- SE O TITULO NAO POSSUIR DATA BASE DE CALCULO, ASSUME A EMISSAO
	IF @RF_BASE_CALC = @DT19000101
		SELECT @RF_BASE_CALC = @TIT_EMISSAO

	EXEC @EH_RESERVA = SIAN_E_RESERVA @RF_BASE_CALC
		,'A'
		,@FER_CHAVE
		,0

	IF @EH_RESERVA <> - 1 -- NAO EH DIA UTIL
		AND @IDX_FCALC <> '007'
		EXEC SIAN_SP_PROXIMA_RESERVA 'A'
			,@FER_CHAVE
			,@RF_BASE_CALC OUTPUT
			,0

	-- FLAG PARA SABER SE TRUNCA OU ARREDONDA O FINANCEIRO
	SELECT @FIN_TRUNCA = FIN_TRUNCA
	FROM CODIGO_TITULO(NOLOCK)
	WHERE ATV_CODIGO = @ATV_CODIGO
		AND IDX_CODIGO = @IDX_CODIGO
		AND LOCAL_NEGOCIACAO = @PFPJ_LOCAL_NEGOC

	-- VERIFICA SE A POSICAO EH UM FUNDO
	SELECT @EH_FUNDO = 'S'
		,@MERC_DT_AQUIS = ISNULL(FDO_MERCADO_1DIA, 'S')
	FROM FDO_POSICAO_FUNDO(NOLOCK)
	WHERE POS_APELIDO = @PFPJ_APELIDO_EMPRESA

	-- PARA FUNDO COM ESTOQUE CONSOLIDADO, DEVE MARCAR MERCADO SE NÃO FOR A PRIMEIRA COMPRA DO ESTOQUE
	-- RLSILVA
	IF @EH_FUNDO = 'S'
		AND @DT_AQUIS <> (
			SELECT MIN(RFM_DATA)
			FROM RF_MOVIMENTACAO
			WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
			)
	BEGIN
		SELECT @MERC_DT_AQUIS = 'S'
	END

	SELECT @POS_DIA_CENARIO = POS_DIA_CENARIO
	FROM POSICAO(NOLOCK)
	WHERE POS_APELIDO = @PFPJ_APELIDO_EMPRESA

	-- BUSCA A RENDA E O INDEXADOR DE CUSTO
	SELECT @ATV_RENDA = ISNULL(ATV_RENDA, 'X')
		,@ATV_IDX_CUSTO = ATV_IDX_CUSTO
	FROM ATIVO(NOLOCK)
	WHERE ATV_CODIGO = @ATV_CODIGO

	-- CALCULA O PRIMEIRO ANIVERSARIO PARA INDEXADORES COM FORMA DE CALCULO 007
	IF @IDX_FCALC = '007'
	BEGIN
		IF DATEPART(DAY, @DT_AQUIS) < CONVERT(INT, @DIA_ANV)
			SELECT @DT_PRIM_ANV = STUFF(CONVERT(CHAR(8), @DT_AQUIS, 112), 7, 2, @DIA_ANV)
		ELSE
			SELECT @DT_PRIM_ANV = STUFF(CONVERT(CHAR(8), DATEADD(MONTH, 1, @DT_AQUIS), 112), 7, 2, @DIA_ANV)
	END
	ELSE
	BEGIN
		SELECT @DT_PRIM_ANV = @DT_AQUIS
	END

	-- BUSCA DADOS DO DIA ANTERIOR
	SELECT @RFS_QTDE = @FLOAT0
		,@RFS_PRINCIPAL = @FLOAT0
		,@PRINCIPAL_ABERTURA = @FLOAT0
		,@RFS_TAXA_MEDIA = @FLOAT0
		,@RFS_TAXA_MEDIA_U = @FLOAT0
		,@RFS_PU_UTEIS_ANT = @FLOAT0
		,@RFS_PU_MERC_ANT = @FLOAT0
		,@RFS_IOF = @FLOAT0
		,@RFS_IR_ANT = @FLOAT0
		,@RFS_JUROS_ANT = @FLOAT0
		,@RFS_CORRECAO_ANT = @FLOAT0
		,@V_FATR_ACUD_UTES = @FLOAT1
		,@V_FATR_ACUD_MERC = @FLOAT1

	SELECT @RFS_QTDE = ABS(RFS_QTDE + RFS_QTDE_C - RFS_QTDE_V)
		,@RFS_PRINCIPAL = RFS_PRINCIPAL
		,@PRINCIPAL_ABERTURA = RFS_PRINCIPAL
		,@RFS_TAXA_MEDIA = RFS_TAXA_MEDIA
		,@RFS_TAXA_MEDIA_U = RFS_TAXA_MEDIA_U
		,@RFS_PU_UTEIS_ANT = RFS_PU_UTEIS
		,@RFS_PU_MERC_ANT = RFS_PU_MERCADO
		,@RFS_IOF = RFS_IOF
		,@RFS_IR_ANT = RFS_IR_ANT
		,@RFS_JUROS_ANT = RFS_JUROS
		,@RFS_CORRECAO_ANT = RFS_CORRECAO
		,@V_FATR_ACUD_UTES = V_FATR_ACUD_UTES
		,@V_FATR_ACUD_MERC = V_FATR_ACUD_MERC
	FROM RF_SALDOS(NOLOCK)
	WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
		AND RFS_DATA = @DT_UTIL

	--Patricia 13/12/2005
	--Para BS e Empresas seleciona juros/correcao anterior em d-1 (corridos)
	IF @EH_FUNDO = 'N'
	BEGIN
		SELECT @RFS_JUROS_ANT = RFS_JUROS
			,@RFS_CORRECAO_ANT = RFS_CORRECAO
			,@PRINCIPAL_ABERTURA = RFS_PRINCIPAL
			,-- Cleber - 07/10/2006
			@RFS_QTDE = ABS(RFS_QTDE + RFS_QTDE_C - RFS_QTDE_V)
			,@RFS_TAXA_MEDIA = RFS_TAXA_MEDIA
			,@RFS_TAXA_MEDIA_U = RFS_TAXA_MEDIA_U
			,@RFS_PU_UTEIS_ANT = RFS_PU_UTEIS
			,@RFS_PU_MERC_ANT = RFS_PU_MERCADO
			,@RFS_IOF = RFS_IOF
			,@RFS_IR_ANT = RFS_IR_ANT
			,@V_FATR_ACUD_UTES = V_FATR_ACUD_UTES
			,@V_FATR_ACUD_MERC = V_FATR_ACUD_MERC
		FROM RF_SALDOS(NOLOCK)
		WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
			AND RFS_DATA = DATEADD(Day, - 1, @DT_CALC)
	END

	--	SELECT @PRINCIPAL_ABERTURA '@PRINCIPAL_ABERTURA', @DT_CALC '@DT_CALC'
	-- CALCULA O FATOR DE VARIACAO ATE A AQUISICAO
	SELECT @CORRECAO_AQUIS = 0

	IF @EH_FUNDO = 'N'
	BEGIN
		SELECT @RFSC_VALOR = @FLOAT0

		EXEC SIAN_SP_VARIACAO @IDX_CODIGO
			,-- INDEXADOR
			@DT_AQUIS
			,-- DATA DE CALCULO
			@RF_BASE_CALC
			,-- DATA BASE DE CALCULO OU EMISSAO
			@TIT_VENCTO
			,-- DATA DE VENCIMENTO
			@IDX_PC
			,-- PERCENTUAL (CDI OU REF)
			@FLOAT0
			,-- 0.0
			@FLOAT0
			,-- 0.0
			'000'
			,-- '000'
			@FER_CHAVE
			,-- POSICAO PARA CALCULO DE FERIADOS
			@TIT_VENCTO
			,-- ANIVERSARIO
			@RFSC_VALOR OUTPUT
			,-- RETORNA A ULTIMA COTACAO
			@FLOAT1
			,-- 1.0
			@VAR_AQUIS OUTPUT
			,-- VARIAVEL PARA RETORNAR A VARIACAO
			@ERRO OUTPUT
			,-- RETORNA EVENTUAIS ERROS
			'C'
			,-- 'U' -> UTEIS; 'C' -> CORRIDOS
			0
			,-- 0 PARA RETORAR NA VARIAVEL
			@CETIP_SELIC
			,-- TIT. PRIVADOS (C) E TIT. PUBLICOS (S)
			@DT_AQUIS
			,-- DATA PARA IGPM PREVIO
			@SGL_SISTEMA = 'RDF' -- Liana - 22/11/10
	END

	-- APAGA OS SALDOS EXISTENTES A PARTIR DA DATA INICIAL (INCLUSIVE)
	-- RF0531.PRC
	EXEC SANPP_RF_DEL_SALDOS @RF_CARACTERISTICA
		,@DT_CALC

	--  	IF @ATV_CODIGO = 'CRI' OR @ATV_CODIGO = 'L H'
	-- 		SELECT 	@CTB_CURVA = 'C',
	-- 			@FL_IDX_CONTABIL = 'S'
	IF @ATV_CODIGO = 'CRI'
		OR @ATV_CODIGO = 'L H'
		SELECT @FL_IDX_CONTABIL = 'S'

	----------------------------------------------------------------------------------------------------------------------------
	-- LIANA - 26/11/2010 - AJUSTE NO JUROS E DA CORRECAO ANTERIOR QUANDO TEVE VENDA UM DIA ANTES
	SELECT @RFS_QTDE_V_ANT = @FLOAT0
		,@RFS_QTDE_ANT = @FLOAT0
		,@RFS_QTDE_C_ANT = @FLOAT0
		,
		--@RFS_JUROS_ANT_AUX = @FLOAT0,
		@RFS_JUROS_ANT = @FLOAT0
		,@RFS_CORRECAO_ANT_AUX = @FLOAT0

	SELECT @RFS_QTDE_V_ANT = RFS_QTDE_V
		,@RFS_QTDE_ANT = RFS_QTDE
		,@RFS_QTDE_C_ANT = RFS_QTDE_C
		,
		--@RFS_JUROS_ANT_AUX = RFS_JUROS,
		@RFS_JUROS_ANT = RFS_JUROS
		,@RFS_CORRECAO_ANT_AUX = RFS_CORRECAO
	FROM RF_SALDOS(NOLOCK)
	WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
		AND RFS_DATA = DATEADD(Day, - 1, @DT_CALC)

	-- 
	-- 	SELECT 	@RFS_QTDE_V_ANT '@RFS_QTDE_V_ANT',
	-- 		@RFS_QTDE_ANT '@RFS_QTDE_ANT',
	-- 		@RFS_QTDE_C_ANT '@RFS_QTDE_C_ANT',
	-- 		@RFS_JUROS_ANT_AUX '@RFS_JUROS_ANT_AUX',
	-- 		@RFS_CORRECAO_ANT_AUX '@RFS_CORRECAO_ANT_AUX'
	SELECT @PU_JUROS_PGTO_DIA_ANT = ISNULL(SUM(V_PU_CALD), 0)
	FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
	WHERE TITULO_ID = @TITULO_ID
		AND ID_RPAC = @ID_RPAC
		AND ID_T_EVE <> @EVE_AMTC_PCPL
		AND -- EVENTO DE AMORTIZACAO
		--						DT_EVE		>	@DT_UTIL	AND
		DT_EVE = DATEADD(Day, - 1, @DT_CALC)

	SELECT @PU_JUROS_PGTO_DIA = ISNULL(SUM(V_PU_CALD), 0)
	FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
	WHERE TITULO_ID = @TITULO_ID
		AND ID_RPAC = @ID_RPAC
		AND ID_T_EVE <> @EVE_AMTC_PCPL
		AND -- EVENTO DE AMORTIZACAO
		--						DT_EVE		>	@DT_UTIL	AND
		DT_EVE = @DT_CALC

	IF @ATV_AP = 'A'
		AND NOT (
			@TIPO_ESTOQUE = '08'
			AND @RFM_DT_INI = 'C'
			) -- Liana - 12/01/2010
	BEGIN
		SELECT
			--@RFS_JUROS_ANT	 	= CASE	WHEN @RFS_QTDE_V_ANT <> 0 THEN
			--					@RFS_JUROS_ANT_AUX - (@RFS_JUROS_ANT_AUX * @RFS_QTDE_V_ANT / (@RFS_QTDE_ANT + @RFS_QTDE_C_ANT))								
			--			  	ELSE 
			--					@RFS_JUROS_ANT_AUX
			--			  END,
			@RFS_CORRECAO_ANT = CASE 
				WHEN @RFS_QTDE_V_ANT <> 0
					THEN @RFS_CORRECAO_ANT_AUX - (@RFS_CORRECAO_ANT_AUX * @RFS_QTDE_V_ANT / (@RFS_QTDE_ANT + @RFS_QTDE_C_ANT))
				ELSE @RFS_CORRECAO_ANT_AUX
				END
	END
	ELSE
	BEGIN
		SELECT
			--@RFS_JUROS_ANT	 	= CASE	WHEN @RFS_QTDE_C_ANT <> 0 THEN
			--					@RFS_JUROS_ANT_AUX - (@RFS_JUROS_ANT_AUX * @RFS_QTDE_C_ANT / (@RFS_QTDE_ANT + @RFS_QTDE_V_ANT))
			--				ELSE
			--					@RFS_JUROS_ANT_AUX
			--			  END,
			@RFS_CORRECAO_ANT = CASE 
				WHEN @RFS_QTDE_C_ANT <> 0
					THEN @RFS_CORRECAO_ANT_AUX - (@RFS_CORRECAO_ANT_AUX * @RFS_QTDE_C_ANT / (@RFS_QTDE_ANT + @RFS_QTDE_V_ANT))
				ELSE @RFS_CORRECAO_ANT_AUX
				END
	END

	-- 	SELECT @RFS_JUROS_ANT '@RFS_JUROS_ANT - ANTES', @DT_CALC '@DT_CALC'
	-- 
	-- 	SELECT ABS(@RFS_QTDE_ANT) * @PU_JUROS_PGTO_DIA_ANT 'JUROS DIA ANTERIOR'
	-- DESCONTAR JUROS PAGOS NO DIA ANTERIOR
	--SELECT @RFS_JUROS_ANT = @RFS_JUROS_ANT - (ABS(@RFS_QTDE_ANT) * @PU_JUROS_PGTO_DIA_ANT)
	--	SELECT @RFS_JUROS_ANT '@RFS_JUROS_ANT - DEPOIS', @DT_CALC '@DT_CALC'
	--	SELECT @RFS_JUROS_ANT '@RFS_JUROS_ANT', @RFS_CORRECAO_ANT '@RFS_CORRECAO_ANT', @DT_CALC '@DT_CALC'
	----------------------------------------------------------------------------------------------------------------------------
	-- 20/05/2019 - Marcio 
	-- Pega qual é o Tipo da Operação, 
	-- Se for 81 - Transferência de Custodia - DE, 
	-- Calcula somente o primeiro e os ultimos x dias, conforme parametro na 515
	SELECT TOP 1 @CD_T_OPRC = CD_T_OPRC
	FROM RF_MOVIMENTACAO MOV(NOLOCK)
	JOIN SANT819_RF_OPERACAO_SIAN T819(NOLOCK) ON MOV.Nro_Operacao = T819.NRO_OPERACAO
	JOIN SANT753_RF_OPERACAO T753(NOLOCK) ON T819.CD_OPRC = T753.CD_OPRC
	WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
	ORDER BY RFM_DATA
		,RFM_HORA

	-- INSERT INTO SANT515_GE_PARAMETRO ( CH_PARM, NM_PARM, CN_PARM, IC_ALTC_PARM)	VALUES ('DCALTRANSF', 'Dias Calculo Transf. Custodia', '15', 'S')

	SELECT TOP 1 @QTD_DIAS_CALC = CONVERT(INT, CN_PARM)
	FROM SANT515_GE_PARAMETRO
	WHERE CH_PARM = 'DCALTRANSF'

	SELECT @DT_CALC_INI = @DT_CALC

	IF EXISTS (
			SELECT 1
			FROM tempdb..sysobjects (nolock)
			WHERE name = '##TMP_CALC_JUROS'
			)
	BEGIN
		DROP TABLE ##TMP_CALC_JUROS

		CREATE TABLE ##TMP_CALC_JUROS (
			DATA DATETIME
			,DATA_EVE DATETIME
			,RF_CARACTERISTICA VARCHAR(20)
			,JUROS FLOAT
			,RFS_PU_UTEIS FLOAT
			,V_PRS_U_JURS FLOAT
			,V_PRS_U_CORC FLOAT
			,V_PRS_U_PCPL FLOAT
			,V_PRS_C_CORC FLOAT
			,V_FUT_U_JURS FLOAT
			,V_FUT_U_CORC FLOAT
			,V_FUT_U_PCPL FLOAT
			)			
	END

	-- Fim - Marcio - Parte 1 
	-- VALORIZA DIA A DIA

	WHILE @DT_CALC <= @DT_FINAL
	BEGIN
		IF @V_PRIM_CALCULO = 'S'
			OR @CD_T_OPRC != 81
			OR (
				@CD_T_OPRC = 81
				AND @DT_CALC >= @DT_FINAL - @QTD_DIAS_CALC
				)
		BEGIN
			SELECT @FL_TIR_RECALCULADA = 'N'

			IF ISNULL(@IC_OPRC_NAO_PADR, 'N') = 'N'
			BEGIN
				-- PARA TITULOS PUBLICOS COM PAGAMENTO DE JUROS DEVE-SE VERIFICAR A DATA DE CORTE
				-- PARA UTILIZACAO DO CENARIO DE VENCIMENTO NO CALCULO DOS FLUXOS SE O CALCULO 
				-- FOR ANTERIOR AO CORTE NAO UTILIZAR O VENCIMENTO
				SELECT @VDT_DTCORTE_CEN_VCMT = CONVERT(DATETIME, CN_PARM)
				FROM SANT515_GE_PARAMETRO
				WHERE CH_PARM = 'CEN_VCMT'

				IF @ATV_FCVALORIZ = '004'
					AND @CETIP_SELIC = 'S'
					AND @DT_CALC < @VDT_DTCORTE_CEN_VCMT
					SELECT @IC_CEN_VCMT = 'N'
				ELSE
					SELECT @IC_CEN_VCMT = @IC_CEN_VCMT_AUX
			END

			-- INICIALIZA AS VARIAVEIS
			SELECT @ERRO = - 1
				,@ERR_MSG = ''
				,@TIR_U = @FLOAT0
				,@TIR_C = @FLOAT0
				,@TIR_M = @FLOAT0
				,@RFS_QTDE_C = @FLOAT0
				,@RFS_QTDE_V = @FLOAT0
				,@RFS_FIN_C = @FLOAT0
				,@RFS_FIN_V = @FLOAT0
				,@QTD_V_CTBL = @FLOAT0
				,@PRINC_CTBL = @FLOAT0
				,@RFS_RESULTADO = @FLOAT0
				,@RFS_IR = @FLOAT0
				,@RFS_IOFR = @FLOAT0
				,@IR_ABERTURA = @FLOAT0
				,@RFS_JUROS = @FLOAT0
				,@RFS_CORRECAO = @FLOAT0
				,@V_PU_CTBL = @FLOAT0
				,@PGT_JUROS = @FLOAT0
				,@PU_PGTO_JUROS = @FLOAT0
				,@RFS_PROVISAO_DIF = @FLOAT0
				,@RFS_PROVISAO = @FLOAT0
				,@RFS_PROVISAO_ANT = @FLOAT0
				,@RFS_PROVISAO_TRANSF = @FLOAT0
				,@V_JURS_CTBL = @FLOAT0
				,@V_CORC_CTBL = @FLOAT0
				,@V_JURS_CTBL_ANTR = @FLOAT0
				,@V_CORC_CTBL_ANTR = @FLOAT0
				,@FIN_APROPRIACAO = @FLOAT0
				,@FIN_PARTIDA = @FLOAT0
				,@FIN_ABE_APROP = @FLOAT0
				,@FIN_ABE_PARTIDA = @FLOAT0
				,@QTDE_SALDO = @FLOAT0
				,@RFSC_VALOR = @FLOAT0
				,@V_PZ_MDIO_CALD = @FLOAT0
				,@V_DURT_CALD = @FLOAT0
				,@RFS_CORRECAO_PAGA = @FLOAT0
				,@V_PU_CTBL_ABERTURA = @FLOAT0
				,
				-- KUBA - 05/12/2016
				@TIR_U_ANT_00 = @FLOAT0
				,@TIR_C_ANT_00 = @FLOAT0
				,@QTDE_ANT_00 = @FLOAT0
				,@RFS_CORRECAO_00 = @FLOAT0
				,@RFS_PU_U_ABERTURA_00 = @FLOAT0
				,@RFS_PU_C_ABERTURA_00 = @FLOAT0
				,@RFS_PU_MERCADO_00 = @FLOAT0
				,@RFSC_VALOR_00 = @FLOAT0
				,@TIR_M_00 = @FLOAT0
				,@V_PZ_MDIO_CALD_00 = @FLOAT0
				,@V_DURT_CALD_00 = @FLOAT0

			-- BUSCA AS QUANTIDADES DE COMPRA OU VENDA DO DIA
			SELECT @RFS_QTDE_C = ISNULL(SUM(CASE 
							WHEN RFM_DT = 'A'
								THEN RFM_QTDE
							ELSE @FLOAT0
							END), @FLOAT0)
				,@RFS_QTDE_V = ISNULL(SUM(CASE 
							WHEN RFM_DT = 'C'
								THEN RFM_QTDE
							ELSE @FLOAT0
							END), @FLOAT0)
				,@RFS_FIN_C = ISNULL(SUM(CASE 
							WHEN RFM_DT = 'A'
								THEN RFM_FINANCEIRO
							ELSE @FLOAT0
							END), @FLOAT0)
				,@RFS_FIN_V = ISNULL(SUM(CASE 
							WHEN RFM_DT = 'C'
								THEN RFM_FINANCEIRO
							ELSE @FLOAT0
							END), @FLOAT0)
				,
				-- 			@PGT_JUROS	= ISNULL( SUM( CASE	WHEN RFM_DT = 'B' AND RFM_LIQ = 'S' THEN RFM_FINANCEIRO  
				-- 								ELSE @FLOAT0
				-- 							END), @FLOAT0),
				-- 			@PU_PGTO_JUROS	= ISNULL( SUM( CASE	WHEN RFM_DT = 'B' AND RFM_LIQ = 'S' THEN RFM_PU
				-- 								ELSE @FLOAT0
				-- 							END), @FLOAT0),
				@RFS_IOF = @RFS_IOF + ISNULL(SUM(RFM_IOF), @FLOAT0)
				,@QTD_V_CTBL = ISNULL(SUM(CASE 
							WHEN (
									(
										@ATV_AP = 'A'
										AND RFM_DT = 'C'
										)
									OR (
										@ATV_AP = 'P'
										AND RFM_DT = 'A'
										)
									)
								AND ISNULL(IC_CLFC_ESTQ, 'N') <> 'S'
								THEN RFM_QTDE
							ELSE @FLOAT0
							END), @FLOAT0)
				,@PRINC_CTBL = ISNULL(SUM(CASE 
							WHEN (
									(
										@ATV_AP = 'A'
										AND RFM_DT = 'C'
										)
									OR (
										@ATV_AP = 'P'
										AND RFM_DT = 'A'
										)
									)
								AND ISNULL(IC_CLFC_ESTQ, 'N') <> 'S'
								THEN RFM_PRINCIPAL
							ELSE @FLOAT0
							END), @FLOAT0)
			FROM RF_MOVIMENTACAO(NOLOCK)
			WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
				AND RFM_OK = 'S'
				AND (
					(
						RFM_DATA = @DT_CALC
						AND @TIPO_ESTOQUE = '08'
						)
					OR (
						RFM_DTERMO = @DT_CALC
						AND @TIPO_ESTOQUE <> '08'
						)
					)

			SELECT @DT_UTIL = @DT_CALC

			EXEC SIAN_SP_RESERVA_ANTERIOR @FER_CHAVE
				,'A'
				,@DT_UTIL OUTPUT
				,0

			--DANILO ABR-2007: 	Para posicoes com Estoque Consolidado e que nao sejam NAO PADRONIZADAS, redefinir a Data e PU de Aquisicao,
			--			pois pode haver outras aquisicoes no periodo (Valorizacao LOTE)
			IF NOT @IC_OPRC_NAO_PADR = 'S'
				AND EXISTS (
					SELECT *
					FROM POSICAO
					WHERE POS_APELIDO = @PFPJ_APELIDO_EMPRESA
						AND POS_TIPO_ESTOQUE = 'C'
					)
			BEGIN
				SELECT @DT_AQUIS = RFM_DATA
					,@PU_AQUIS = SUM(RFM_FINANCEIRO) / SUM(RFM_QTDE)
				FROM RF_MOVIMENTACAO(NOLOCK)
				WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
					AND RFM_OK = 'S'
					AND RFM_DATA <= @DT_CALC
					AND RFM_QTDE > 0
					AND (
						(
							@ATV_AP = 'A'
							AND RFM_DT = 'A'
							)
						OR
						-- Liana - 12/01/10
						(
							(
								@ATV_AP = 'P'
								OR (
									@ATV_AP = 'A'
									AND @TIPO_ESTOQUE = '08'
									)
								)
							AND RFM_DT = 'C'
							)
						)
				GROUP BY RFM_DATA
				HAVING RFM_DATA = MAX(RFM_DATA)
			END

			-- 11/12/2006
			IF @DT_CALC <= @TIT_VENCTO
				OR @EH_FUNDO = 'S'
				SELECT @RFS_PU_UTEIS = @FLOAT0
					,@RFS_PU_CORRIDOS = @FLOAT0
					,@RFS_PU_MERCADO = @FLOAT0

			-- SEPARA AS TAXAS UTEIS E CORRIDOS
			IF @RFX_FCALC IN (
					'009'
					,'022'
					,'036'
					)
				SELECT @TIR_U = @RFS_TAXA_MEDIA
					,@TIR_C = @RFS_TAXA_MEDIA_U
			ELSE
				SELECT @TIR_U = @RFS_TAXA_MEDIA_U
					,@TIR_C = @RFS_TAXA_MEDIA

			-- SE A PROXIMA REPACTUACAO FOR CORRECAO, CALCULA A TAXA PRIMEIRO
			IF @IC_OPRC_NAO_PADR = 'S'
				AND @DT_CALC >= @DT_FIM_RPAC
				AND EXISTS (
					SELECT TOP 1 TITULO_ID
					FROM SANT643_RF_REPAC_TITULO(NOLOCK)
					WHERE TITULO_ID = @TITULO_ID
						AND ID_RPAC = @ID_RPAC + 1
						AND IC_EVE_CORC_TIT = 'S'
					)
			BEGIN
				IF @DT_CALC > @TIT_VENCTO
					SELECT @DATA = @TIT_VENCTO
				ELSE
					SELECT @DATA = @DT_CALC

				SELECT @IDX_CODIGO = B.IDX_CODIGO
					,@TIT_VENCTO = B.DT_VCMT
					,@TIT_CUPOM = B.V_TXA_RPAC
					,@ATV_FCVALORIZ = B.ATV_FCVALORIZ
					,@ID_RPAC = B.ID_RPAC
					,@IDX_PC = B.IDX_PC
					,@DT_INIC_RPAC = B.DT_INIC_RPAC
					,@DT_PROX_RPAC = B.DT_FIM_RPAC
					,--CRISTIANO MONEGATTO - 21/08/2013
					@DT_FIM_RPAC = B.DT_FIM_RPAC
					,@V_PU_PMIO = B.V_PU_PMIO
					,@RFX_FCALC = B.FC_JUROS
					,@RF_BASE_CALC = B.RF_BASE_CALC
					,@IC_EVE_CORC_TIT = ISNULL(B.IC_EVE_CORC_TIT, 'N')
					,@V_PU_CORC = ISNULL(B.V_PU_CORC, 0)
				FROM RF_TITULO A(NOLOCK)
					,SANT643_RF_REPAC_TITULO B(NOLOCK)
				WHERE A.TITULO_ID = @TITULO_ID
					AND A.TITULO_ID = B.TITULO_ID
					AND @DATA BETWEEN B.DT_INIC_RPAC
						AND B.DT_FIM_RPAC

				IF @@ROWCOUNT = 0
				BEGIN
					SELECT @ERR_MSG = @RF_CARACTERISTICA + ': NAO EXISTE REPACTUACAO. TITULO_ID: ' + RTRIM(CONVERT(CHAR, @TITULO_ID)) + '. DATA: ' + CONVERT(CHAR(10), @DT_CALC, 103)

					IF @RETORNA_MSG <> 'S'
						RAISERROR 70001 @ERR_MSG
					ELSE
						SELECT @MENSAGEM_ERRO = @ERR_MSG

					RETURN
				END

				-- Somente para titulos que NÃO são calculo manual (RFX_RESULTADO = '006')
				-- By Charlie - 10/06/2019
				IF NOT EXISTS (
						SELECT 1
						FROM RF_INDEXACAO
						WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
							AND RFX_RESULTADO = '006'
						)
				BEGIN
					-- Por causa do descasamento da data de vencimento com a data de liquidação do evento
					-- a valorização tem que usar como vencimento o último DT_EVE dos fluxos
					-- By Charlie - 18/06/2015
					IF EXISTS (
							SELECT 1
							FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
							WHERE TITULO_ID = @TITULO_ID
								AND ID_RPAC = @ID_RPAC
							)
					BEGIN
						SELECT @TIT_VENCTO = MAX(DT_EVE)
						FROM SANT644_RF_AGENDA_EVENTO
						WHERE TITULO_ID = @TITULO_ID
							AND ID_RPAC = @ID_RPAC
					END
				END

				-- A REPACTUACAO SEMPRE EXPIRA NA PROXIMA RESERVA
				EXEC SIAN_SP_PROXIMA_RESERVA 'A'
					,@FER_CHAVE
					,@DT_FIM_RPAC OUTPUT
					,0

				-- VERIFICA A FORMA DE CALCULO DO CUPOM
				SELECT @FCALC_CUPOM = CASE 
						WHEN IDX_TIPO = 'M'
							AND @TIT_EMISSAO > @DT20000801
							THEN '033'
						WHEN IDX_TIPO = 'M'
							OR (
								IDX_TIPO = 'I'
								AND @CETIP_SELIC = 'S'
								)
							THEN '013'
						ELSE @RFX_FCALC
						END
					,@IDX_FCALC = IDX_FCALC
					,@IDX_PRE = IDX_PRE
					,@IDX_TIPO = IDX_TIPO
				FROM INDEXADOR(NOLOCK)
				WHERE IDX_CODIGO = @IDX_CODIGO

				-- FLAG PARA SABER SE TRUNCA OU ARREDONDA O FINANCEIRO
				SELECT @FIN_TRUNCA = FIN_TRUNCA
				FROM CODIGO_TITULO(NOLOCK)
				WHERE ATV_CODIGO = @ATV_CODIGO
					AND IDX_CODIGO = @IDX_CODIGO
					AND LOCAL_NEGOCIACAO = @PFPJ_LOCAL_NEGOC
			END

			---- KUBA - 05/12/2016 - CALCULO DE DEBENTURES
			SELECT @RFS_QTDE_C_00 = ISNULL(SUM(CASE 
							WHEN RFM_DT = 'A'
								THEN RFM_QTDE
							ELSE @FLOAT0
							END), @FLOAT0)
				,@RFS_FIN_C_00 = ISNULL(SUM(CASE 
							WHEN RFM_DT = 'A'
								THEN RFM_FINANCEIRO
							ELSE @FLOAT0
							END), @FLOAT0)
			FROM RF_MOVIMENTACAO(NOLOCK)
			WHERE RF_CARACTERISTICA = @RF_CARACT_00
				AND RFM_OK = 'S'
				AND RFM_DTERMO = @DT_CALC

			--SELECT 	@DT_ANT = DATEADD(DAY, -1, @DT_CALC)
			--SELECT @TIR_U_ANT_00 = isnull(CASE WHEN @RFX_FCALC IN ('009', '022', '036') THEN  RFS_TAXA_MEDIA ELSE RFS_TAXA_MEDIA_U END, 0),
			--		   @TIR_C_ANT_00 = ISNULL(CASE WHEN @RFX_FCALC IN ('009', '022', '036') THEN  RFS_TAXA_MEDIA_U ELSE RFS_TAXA_MEDIA END, 0),
			--		   @QTDE_ANT_00		= ISNULL( (RFS_QTDE + RFS_QTDE_C - RFS_QTDE_V ), 0),
			--		   @FIN_ABERTURA_00 = (RFS_QTDE + RFS_QTDE_C - RFS_QTDE_V) * RFS_PU_CORRIDOS
			--FROM RF_SALDOS 
			--WHERE RF_CARACTERISTICA = @RF_CARACT_00 AND RFS_DATA = @DT_ANT
			---- KUBA - FIM - 
			-- SE FOR DATA DE AQUISICAO OU MES DE AQUISICAO (IGPM) RECALCULA A TIR
			-- NO MES DE MUDANCA DO PERIODO DE REPACTUACAO (APOS A REPAC.), TAMBEM.
			IF @DT_CALC = @DT_AQUIS
				OR @DT_CALC = @DT_INIC_RPAC
				OR (
					@RFS_QTDE_C_00 > 0
					AND @ATV_AP = 'A'
					) -- KUBA - RECALCULA A TIR QUANDO HOUVER UMA COMPRA 
			BEGIN
				-- SE FOR UM EVENTO DE CORRECAO, VERIFICA SE FOI DIGITADO O PU DE CORRECAO
				IF @IC_EVE_CORC_TIT = 'S'
					AND (
						@DT_CALC = @DT_INIC_RPAC
						OR (
							@IDX_FCALC = '007'
							AND @DT_CALC > @DT_INIC_RPAC
							AND DatePart(year, @DT_CALC) = DatePart(year, @DT_INIC_RPAC)
							AND DatePart(month, @DT_CALC) = DatePart(month, @DT_INIC_RPAC)
							)
						)
				BEGIN
					IF @V_PU_CORC <> 0
						SELECT @RFS_PU_TIR = @V_PU_CORC
					ELSE
						SELECT @RFS_PU_TIR = RFS_PU_UTEIS
						FROM RF_SALDOS(NOLOCK)
						WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
							AND RFS_DATA = @DT_INIC_RPAC
				END
				ELSE
				BEGIN
					SELECT @FL_TIR_RECALCULADA = 'S'

					-- KUBA - 05/12/2016 - CALCULO DE DEBENTURES
					--SELECT	@RFS_QTDE_C_00	= ISNULL( SUM( CASE	WHEN RFM_DT = 'A' THEN RFM_QTDE ELSE @FLOAT0 END), @FLOAT0),
					--		@RFS_FIN_C_00	= ISNULL( SUM( CASE	WHEN RFM_DT = 'A' THEN RFM_FINANCEIRO ELSE @FLOAT0 END), @FLOAT0)
					--FROM RF_MOVIMENTACAO   (NOLOCK)  
					--WHERE	RF_CARACTERISTICA	= @RF_CARACT_00	AND RFM_OK = 'S' 
					--		AND RFM_DTERMO	= @DT_CALC
					SELECT @DT_ANT = DATEADD(DAY, - 1, @DT_CALC)

					SELECT @TIR_U_ANT_00 = isnull(CASE 
								WHEN @RFX_FCALC IN (
										'009'
										,'022'
										,'036'
										)
									THEN RFS_TAXA_MEDIA
								ELSE RFS_TAXA_MEDIA_U
								END, 0)
						,@TIR_C_ANT_00 = ISNULL(CASE 
								WHEN @RFX_FCALC IN (
										'009'
										,'022'
										,'036'
										)
									THEN RFS_TAXA_MEDIA_U
								ELSE RFS_TAXA_MEDIA
								END, 0)
						,@QTDE_ANT_00 = ISNULL((RFS_QTDE + RFS_QTDE_C - RFS_QTDE_V), 0)
						,@FIN_ABERTURA_00 = (RFS_QTDE + RFS_QTDE_C - RFS_QTDE_V) * RFS_PU_CORRIDOS
					FROM RF_SALDOS
					WHERE RF_CARACTERISTICA = @RF_CARACT_00
						AND RFS_DATA = @DT_ANT

					-- KUBA - FIM - 
					IF @QTDE_ANT_00 > 0
					BEGIN
						EXEC SANPP_RF_CALC_PU_DIA @RF_CARACTERISTICA
							,-- OPERACAO A SER CALCULADA.
							@DT_CALC
							,-- DATA DE CALCULO DO PU
							@TITULO_ID
							,-- IDENTIFICADOR DO TITULO
							@ID_RPAC
							,-- IDENTIFICADOR DO PERIODO DE REPACTUACAO OU ZERO PARA PADRONIZADOS
							@IC_OPRC_NAO_PADR
							,-- INDICADOR DE OPERACAO NAO PADRONIZADA
							@TIT_EMISSAO
							,-- EMISSAO DO TITULO
							@TIT_VENCTO
							,-- VENCIMENTO DO TITULO
							@TIT_CUPOM
							,-- CUPOM DO TITULO
							@RFX_FCALC
							,-- FORMA DE CALCULO DE JUROS
							@FCALC_CUPOM
							,-- FORMA DE CALCULO DO CUPOM
							@IDX_CODIGO
							,-- INDEXADOR DE CORRECAO
							@DT_AQUIS
							,-- DATA DE AQUISICAO DO TITULO
							@DT_INIC_RPAC
							,-- DATA DE INICIAL DA REPACTUACAO
							@DT_PROX_RPAC
							,-- DATA DA PROXIMA REPACTUACAO
							@RF_BASE_CALC
							,-- DATA BASE DE CALCULO DO TITULO
							@IDX_PC
							,-- PERCENTUAL DO INDEXADOR
							@FER_CHAVE
							,-- POSICAO PARA FERIADOS
							@EH_FUNDO
							,-- FLAG PARA FUNDO OU NAO
							@CETIP_SELIC
							,-- 'C'ETIP PARA PRIVADOS OU 'S'ELIC PARA PUBLICOS
							@ATV_PRZ_PGJUROS
							,-- PRAZO DE PAGAMENTO DE JUROS PARA NTNs E NBC-Es
							@ATV_LOTE
							,-- NOMINAL DO TITULO PARA NTNs E NBC-Es
							@CTB_CURVA
							,-- CURVA DE CONTABILIZACAO
							@RFX_RESULTADO
							,-- FORMA DE CALCULO DA CURVA MERCADO
							@SGL_MEDA
							,-- SIGLA DA MOEDA APC
							@IC_CEN_VCMT
							,-- INDICADOR DE CENARIO DO VENCIMENTO
							@IDX_GERENCIAL
							,-- INDEXADOR GERENCIAL PARA PU MANUAL
							@ATV_IDX_CUSTO
							,-- INDEXADOR DE CUSTO PARA MTM PRE
							@MERC_DT_AQUIS
							,-- INDICADOR DE CALCULO DO CENARIO EM DATA DE AQUISICAO
							@TIR_U_ANT_00
							,-- TIR UTEIS
							@TIR_C_ANT_00
							,-- TIR CORRIDOS
							@RFS_CORRECAO_00 OUTPUT
							,-- VARIACAO PARA O CALCULO DA CORRECAO
							@RFS_PU_U_ABERTURA_00 OUTPUT
							,-- RETORNA O PU UTEIS
							@RFS_PU_C_ABERTURA_00 OUTPUT
							,-- RETORNA O PU CORRIDOS
							@RFS_PU_MERCADO_00 OUTPUT
							,-- RETORNA O PU MERCADO
							@RFSC_VALOR_00 OUTPUT
							,-- RETORNA A ULTIMA COTACAO
							@TIR_M_00 OUTPUT
							,-- RETORNA A TIR MERCADO
							@DT_ACABOU_CEN_00 OUTPUT
							,-- RETORNA A DATA QUE ACABOU O CENARIO
							@ERRO OUTPUT
							,-- RETORNA 0 QUANDO ERRO
							@ERR_MSG OUTPUT
							,-- MENSAGEM DE ERRO
							NULL
							,-- CALCULO PELO SQL
							@V_PZ_MDIO_CALD_00 OUTPUT
							,-- PRAZO MEDIO DA OPERACAO
							@V_DURT_CALD_00 OUTPUT
							,-- DURATION DA OPERACAO
							@FL_DESCAP
							,-- DESCAP. POR 252/360
							@FL_IDX_CONTABIL -- CALC. FATOR CORRECAO POR UTEIS/CORRIDOS

						SELECT @DT_AQUIS = @DT_CALC
					END
					ELSE IF @RFS_QTDE_C_00 > 0
						SELECT @DT_AQUIS = @DT_CALC

					-- CALCULA FINANCEIRO DE ABERTURA
					SELECT @FIN_ABERTURA_00 = @RFS_QTDE * @RFS_PU_C_ABERTURA_00

					-- CALCULA PU MÉDIO DE AQUISIÇÃO
					IF (
							@RFS_QTDE_C_00 > 0
							OR @QTDE_ANT_00 > 0
							)
						AND (@RFS_QTDE_C_00 + @QTDE_ANT_00 <> 0)
						SELECT @RFS_PU_TIR = (@FIN_ABERTURA_00 + @RFS_FIN_C_00) / (@QTDE_ANT_00 + @RFS_QTDE_C_00)
					ELSE
						SELECT @RFS_PU_TIR = @PU_AQUIS
				END

				-- SE FOI REPACTUADO O PU DE PARTIDA EH O PU NA DATA DE REPACTUACAO
				IF (
						@IDX_FCALC = '007'
						AND @DT_CALC > @DT_INIC_RPAC
						AND DatePart(year, @DT_CALC) = DatePart(year, @DT_INIC_RPAC)
						AND DatePart(month, @DT_CALC) = DatePart(month, @DT_INIC_RPAC)
						)
				BEGIN
					-- SE FOR UM EVENTO DE CORRECAO, VERIFICA SE FOI DIGITADO O PU DE CORRECAO
					IF @IC_EVE_CORC_TIT = 'S'
						AND @V_PU_CORC <> 0
						SELECT @RFS_PU_TIR = @V_PU_CORC
					ELSE
						SELECT @RFS_PU_TIR = RFS_PU_UTEIS
						FROM RF_SALDOS(NOLOCK)
						WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
							AND RFS_DATA = @DT_INIC_RPAC
				END

				IF @RFX_RESULTADO <> '006'
					OR @EH_FUNDO = 'S'
				BEGIN
					-- RF0886.PRC
					EXEC SANPP_RF_CALC_TIR_DIA @RF_CARACTERISTICA
						,-- OPERACAO A SER CALCULADA OU CODIGO DE CONTROLE
						@DT_CALC
						,-- DATA EM QUE A TIR ESTA SENDO CALCULADA
						@TITULO_ID
						,-- IDENTIFICADOR DO TITULO
						@ID_RPAC
						,-- IDENTIFICADOR DO PERIODO DE REPACTUACAO OU ZERO PARA PADRONIZADOS
						@IC_OPRC_NAO_PADR
						,-- INDICADOR DE OPERACAO NAO PADRONIZADA
						@TIT_EMISSAO
						,-- EMISSAO DO TITULO
						@TIT_VENCTO
						,-- VENCIMENTO DO TITULO
						@TIT_CUPOM
						,-- CUPOM DO TITULO
						@RFX_FCALC
						,-- FORMA DE CALCULO DE JUROS
						@FCALC_CUPOM
						,-- FORMA DE CALCULO DO CUPOM
						@IDX_CODIGO
						,-- INDEXADOR DE CORRECAO
						@DT_AQUIS
						,-- DATA DE AQUISICAO DO TITULO
						@DT_INIC_RPAC
						,-- DATA INICIAL DA REPACTUACAO OU EMISSAO PARA PADRONIZADOS
						@DT_PROX_RPAC
						,-- DATA DA PROXIMA REPACTUACAO
						@RFS_PU_TIR
						,-- PU DE AQUISICAO DO TITULO OU DA REPACTUACAO
						@PMIO_AQUIS
						,-- PREMIO DADO NA BOLETAGEM NPDR OU ZERO NOS DEMAIS CASOS
						@V_PU_PMIO
						,-- PREMIO DADO NA REPACTUACAO NPDR OU ZERO NOS DEMAIS CASOS
						@RF_BASE_CALC
						,-- DATA BASE DE CALCULO DO TITULO
						@IDX_PC
						,-- PERCENTUAL DO INDEXADOR
						@FER_CHAVE
						,-- POSICAO PARA FERIADOS
						@CETIP_SELIC
						,-- 'C'ETIP PARA PRIVADOS OU 'S'ELIC PARA PUBLICOS
						@ATV_PRZ_PGJUROS
						,-- PRAZO DE PAGAMENTO DE JUROS PARA NTNs E NBC-Es
						@ATV_LOTE
						,-- NOMINAL DO TITULO PARA NTNs E NBC-Es
						@TIR_U OUTPUT
						,-- RETORNA A TIR UTEIS
						@TIR_C OUTPUT
						,-- RETORNA A TIR CORRIDOS
						@ERRO OUTPUT
						,-- RETORNA 0 QUANDO ERRO
						@ERR_MSG OUTPUT
						,-- MENSAGEM DE ERRO
						NULL
						,-- NAO RETORNA RECORDSET
						@FL_DESCAP
						,-- DESCAP. POR 252/360
						@FL_IDX_CONTABIL -- CALC. FATOR CORRECAO POR UTEIS/CORRIDOS

					IF @ERRO <> - 1
					BEGIN
						IF @RETORNA_MSG <> 'S'
							RAISERROR 70001 @ERR_MSG
						ELSE
							SELECT @MENSAGEM_ERRO = @ERR_MSG

						RETURN
					END
				END
			END

			--DOUGMIR 14/08/14 SEPARADO PAGTO DE JUROS PARA NÃO RETORNAR O VALOR QUANDO NÃO HOUVER AMORTIZACAO
			IF @IC_OPRC_NAO_PADR = 'S'
			BEGIN
				SELECT @PGT_JUROS = ISNULL(SUM(CASE 
								WHEN RFM_DT = 'B'
									AND RFM_LIQ = 'S'
									THEN RFM_FINANCEIRO
								ELSE @FLOAT0
								END), @FLOAT0)
					,@PU_PGTO_JUROS = ISNULL(SUM(CASE 
								WHEN RFM_DT = 'B'
									AND RFM_LIQ = 'S'
									THEN RFM_PU
								ELSE @FLOAT0
								END), @FLOAT0)
				FROM RF_MOVIMENTACAO(NOLOCK)
				WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
					AND RFM_OK = 'S'
					AND (
						(
							RFM_DATA = @DT_CALC
							AND @TIPO_ESTOQUE = '08'
							)
						OR (
							RFM_DTERMO = @DT_CALC
							AND @TIPO_ESTOQUE <> '08'
							)
						)
			END
						
			--		select @PGT_JUROS '@PGT_JUROS'
			-- TRUNCA OU ARREDONDA OS PRINCIPAIS
			IF @FIN_TRUNCA = 'S'
			BEGIN
				EXEC TRUNC @RFS_PRINCIPAL
					,2
					,@RFS_PRINCIPAL OUTPUT

				EXEC TRUNC @PRINC_CTBL
					,2
					,@PRINC_CTBL OUTPUT
			END
			ELSE
			BEGIN
				SELECT @RFS_PRINCIPAL = ROUND(@RFS_PRINCIPAL, 2)
					,@PRINC_CTBL = ROUND(@PRINC_CTBL, 2)
			END

			
			-- APURA A QUANTIDADE DE SALDO
			IF @ATV_AP = 'P'
				OR (
					@TIPO_ESTOQUE = '08'
					AND @RFM_DT_INI = 'C'
					)
				SELECT @QTDE_SALDO = ABS(@RFS_QTDE_C - @RFS_QTDE_V - @RFS_QTDE)
			ELSE
				SELECT @QTDE_SALDO = ABS(@RFS_QTDE_C - @RFS_QTDE_V + @RFS_QTDE)

			-- CALCULA OS PUs
			-- RF0884.PRC
			IF @DT_CALC <= @TIT_VENCTO
				OR @EH_FUNDO = 'S' --DANILO, Para valorizar após o vencimento para Fundos
			BEGIN
				IF @TIPO_ESTOQUE = '08' --AND (@EH_FUNDO = 'S' OR EXISTS(SELECT POS_APELIDO FROM FDO_POSICAO_FUNDO WHERE POS_APELIDO	= @PFPJ_APELIDO_CLIENTE))
				BEGIN
					SET @RFS_CORRECAO_AUX = @RFS_CORRECAO
					SET @RFS_PU_UTEIS_AUX = @RFS_PU_UTEIS
					SET @RFS_PU_CORRIDOS_AUX = @RFS_PU_CORRIDOS
					SET @RFS_PU_MERCADO_AUX = @RFS_PU_MERCADO
					SET @RFSC_VALOR_AUX = @RFSC_VALOR
					SET @TIR_M_AUX = @TIR_M
					SET @DT_ACABOU_CEN_AUX = @DT_ACABOU_CEN
					SET @V_PZ_MDIO_CALD_AUX = @V_PZ_MDIO_CALD
					SET @V_DURT_CALD_AUX = @V_DURT_CALD

					EXEC SANPP_RF_CALC_PU_DIA @RF_CARACTERISTICA
						,-- OPERACAO A SER CALCULADA.
						@RFM_DTERMO
						,-- DATA DE CALCULO DO PU
						@TITULO_ID
						,-- IDENTIFICADOR DO TITULO
						@ID_RPAC
						,-- IDENTIFICADOR DO PERIODO DE REPACTUACAO OU ZERO PARA PADRONIZADOS
						@IC_OPRC_NAO_PADR
						,-- INDICADOR DE OPERACAO NAO PADRONIZADA
						@TIT_EMISSAO
						,-- EMISSAO DO TITULO
						@TIT_VENCTO
						,-- VENCIMENTO DO TITULO
						@TIT_CUPOM
						,-- CUPOM DO TITULO
						@RFX_FCALC
						,-- FORMA DE CALCULO DE JUROS
						@FCALC_CUPOM
						,-- FORMA DE CALCULO DO CUPOM
						@IDX_CODIGO
						,-- INDEXADOR DE CORRECAO
						@DT_AQUIS
						,-- DATA DE AQUISICAO DO TITULO
						@DT_INIC_RPAC
						,-- DATA DE INICIAL DA REPACTUACAO
						@DT_PROX_RPAC
						,-- DATA DA PROXIMA REPACTUACAO
						@RF_BASE_CALC
						,-- DATA BASE DE CALCULO DO TITULO
						@IDX_PC
						,-- PERCENTUAL DO INDEXADOR
						--'BRILHANTE',
						@FER_CHAVE
						,-- POSICAO PARA FERIADOS
						@EH_FUNDO
						,-- FLAG PARA FUNDO OU NAO
						@CETIP_SELIC
						,-- 'C'ETIP PARA PRIVADOS OU 'S'ELIC PARA PUBLICOS
						@ATV_PRZ_PGJUROS
						,-- PRAZO DE PAGAMENTO DE JUROS PARA NTNs E NBC-Es
						@ATV_LOTE
						,-- NOMINAL DO TITULO PARA NTNs E NBC-Es
						@CTB_CURVA
						,-- CURVA DE CONTABILIZACAO
						@RFX_RESULTADO
						,-- FORMA DE CALCULO DA CURVA MERCADO
						@SGL_MEDA
						,-- SIGLA DA MOEDA APC
						@IC_CEN_VCMT
						,-- INDICADOR DE CENARIO DO VENCIMENTO
						@IDX_GERENCIAL
						,-- INDEXADOR GERENCIAL PARA PU MANUAL
						@ATV_IDX_CUSTO
						,-- INDEXADOR DE CUSTO PARA MTM PRE
						@MERC_DT_AQUIS
						,-- INDICADOR DE CALCULO DO CENARIO EM DATA DE AQUISICAO
						@TIR_U
						,-- TIR UTEIS
						@TIR_C
						,-- TIR CORRIDOS
						@RFS_CORRECAO OUTPUT
						,-- VARIACAO PARA O CALCULO DA CORRECAO
						@RFS_PU_UTEIS OUTPUT
						,-- RETORNA O PU UTEIS
						@RFS_PU_CORRIDOS OUTPUT
						,-- RETORNA O PU CORRIDOS
						@RFS_PU_MERCADO OUTPUT
						,-- RETORNA O PU MERCADO
						@RFSC_VALOR OUTPUT
						,-- RETORNA A ULTIMA COTACAO
						@TIR_M OUTPUT
						,-- RETORNA A TIR MERCADO
						@DT_ACABOU_CEN OUTPUT
						,-- RETORNA A DATA QUE ACABOU O CENARIO
						@ERRO OUTPUT
						,-- RETORNA 0 QUANDO ERRO
						@ERR_MSG OUTPUT
						,-- MENSAGEM DE ERRO
						NULL
						,-- CALCULO PELO SQL
						@V_PZ_MDIO_CALD OUTPUT
						,-- PRAZO MEDIO DA OPERACAO
						@V_DURT_CALD OUTPUT
						,-- DURATION DA OPERACAO
						@FL_DESCAP
						,-- DESCAP. POR 252/360
						@FL_IDX_CONTABIL
						,-- CALC. FATOR CORRECAO POR UTEIS/CORRIDOS
						@DT_CALC

					IF @IDX_PRE = 'S' --CALCULAR COM A TAXA AJUSTADA
					BEGIN
						SET @V_DURT_CALD_VOLTA = @V_DURT_CALD
						SET @RFS_CORRECAO = @RFS_CORRECAO_AUX
						SET @RFS_PU_UTEIS = @RFS_PU_UTEIS_AUX
						SET @RFS_PU_CORRIDOS = @RFS_PU_CORRIDOS_AUX
						SET @RFS_PU_MERCADO = @RFS_PU_MERCADO_AUX
						SET @RFSC_VALOR = @RFSC_VALOR_AUX
						SET @TIR_M = @TIR_M_AUX
						SET @DT_ACABOU_CEN = @DT_ACABOU_CEN_AUX
						SET @V_PZ_MDIO_CALD = @V_PZ_MDIO_CALD_AUX
												
						EXEC SANPP_RF_CALC_PU_DIA @RF_CARACTERISTICA
							,-- OPERACAO A SER CALCULADA.
							@RFM_DTERMO
							,-- DATA DE CALCULO DO PU
							@TITULO_ID
							,-- IDENTIFICADOR DO TITULO
							@ID_RPAC
							,-- IDENTIFICADOR DO PERIODO DE REPACTUACAO OU ZERO PARA PADRONIZADOS
							@IC_OPRC_NAO_PADR
							,-- INDICADOR DE OPERACAO NAO PADRONIZADA
							@TIT_EMISSAO
							,-- EMISSAO DO TITULO
							@TIT_VENCTO
							,-- VENCIMENTO DO TITULO
							@TIT_CUPOM
							,-- CUPOM DO TITULO
							@RFX_FCALC
							,-- FORMA DE CALCULO DE JUROS
							@FCALC_CUPOM
							,-- FORMA DE CALCULO DO CUPOM
							@IDX_CODIGO
							,-- INDEXADOR DE CORRECAO
							@DT_AQUIS
							,-- DATA DE AQUISICAO DO TITULO
							@DT_INIC_RPAC
							,-- DATA DE INICIAL DA REPACTUACAO
							@DT_PROX_RPAC
							,-- DATA DA PROXIMA REPACTUACAO
							@RF_BASE_CALC
							,-- DATA BASE DE CALCULO DO TITULO
							@IDX_PC
							,-- PERCENTUAL DO INDEXADOR
							--'BRILHANTE',
							@FER_CHAVE
							,-- POSICAO PARA FERIADOS
							@EH_FUNDO
							,-- FLAG PARA FUNDO OU NAO
							@CETIP_SELIC
							,-- 'C'ETIP PARA PRIVADOS OU 'S'ELIC PARA PUBLICOS
							@ATV_PRZ_PGJUROS
							,-- PRAZO DE PAGAMENTO DE JUROS PARA NTNs E NBC-Es
							@ATV_LOTE
							,-- NOMINAL DO TITULO PARA NTNs E NBC-Es
							@CTB_CURVA
							,-- CURVA DE CONTABILIZACAO
							@RFX_RESULTADO
							,-- FORMA DE CALCULO DA CURVA MERCADO
							@SGL_MEDA
							,-- SIGLA DA MOEDA APC
							@IC_CEN_VCMT
							,-- INDICADOR DE CENARIO DO VENCIMENTO
							@IDX_GERENCIAL
							,-- INDEXADOR GERENCIAL PARA PU MANUAL
							@ATV_IDX_CUSTO
							,-- INDEXADOR DE CUSTO PARA MTM PRE
							@MERC_DT_AQUIS
							,-- INDICADOR DE CALCULO DO CENARIO EM DATA DE AQUISICAO
							@TIR_U
							,-- TIR UTEIS
							@TIR_C
							,-- TIR CORRIDOS
							@RFS_CORRECAO OUTPUT
							,-- VARIACAO PARA O CALCULO DA CORRECAO
							@RFS_PU_UTEIS OUTPUT
							,-- RETORNA O PU UTEIS
							@RFS_PU_CORRIDOS OUTPUT
							,-- RETORNA O PU CORRIDOS
							@RFS_PU_MERCADO OUTPUT
							,-- RETORNA O PU MERCADO
							@RFSC_VALOR OUTPUT
							,-- RETORNA A ULTIMA COTACAO
							@TIR_M OUTPUT
							,-- RETORNA A TIR MERCADO
							@DT_ACABOU_CEN OUTPUT
							,-- RETORNA A DATA QUE ACABOU O CENARIO
							@ERRO OUTPUT
							,-- RETORNA 0 QUANDO ERRO
							@ERR_MSG OUTPUT
							,-- MENSAGEM DE ERRO
							NULL
							,-- CALCULO PELO SQL
							@V_PZ_MDIO_CALD OUTPUT
							,-- PRAZO MEDIO DA OPERACAO
							@V_DURT_CALD OUTPUT
							,-- DURATION DA OPERACAO
							@FL_DESCAP
							,-- DESCAP. POR 252/360
							@FL_IDX_CONTABIL
							,-- CALC. FATOR CORRECAO POR UTEIS/CORRIDOS
							@DT_CALC
							,@V_DURT_CALD_VOLTA
					END

					SET @RFS_PU_UTEIS = @RFM_PU_NEG_TERM
					SET @RFS_PU_CORRIDOS = @RFM_PU_NEG_TERM

					EXEC SANPP_RF_CALC_PU_DIA_TERMO @RFS_PU_MERCADO OUTPUT
						,@RFS_PU_UTEIS OUTPUT
						,@RFS_PU_CORRIDOS OUTPUT
						,@DT_CALC
						,@RFM_DTERMO
						,@TIT_VENCTO
						,@IC_CEN_VCMT
						,@FER_CHAVE
						,@EH_FUNDO
						,@IDX_CODIGO
						,@POS_DIA_CENARIO
						,@DT_AQUIS
						,'A'
						,@CTB_CURVA
				END
				ELSE
				BEGIN					

					EXEC SANPP_RF_CALC_PU_DIA @RF_CARACTERISTICA
						,-- OPERACAO A SER CALCULADA.
						@DT_CALC
						,-- DATA DE CALCULO DO PU
						@TITULO_ID
						,-- IDENTIFICADOR DO TITULO
						@ID_RPAC
						,-- IDENTIFICADOR DO PERIODO DE REPACTUACAO OU ZERO PARA PADRONIZADOS
						@IC_OPRC_NAO_PADR
						,-- INDICADOR DE OPERACAO NAO PADRONIZADA
						@TIT_EMISSAO
						,-- EMISSAO DO TITULO
						@TIT_VENCTO
						,-- VENCIMENTO DO TITULO
						@TIT_CUPOM
						,-- CUPOM DO TITULO
						@RFX_FCALC
						,-- FORMA DE CALCULO DE JUROS
						@FCALC_CUPOM
						,-- FORMA DE CALCULO DO CUPOM
						@IDX_CODIGO
						,-- INDEXADOR DE CORRECAO
						@DT_AQUIS
						,-- DATA DE AQUISICAO DO TITULO
						@DT_INIC_RPAC
						,-- DATA DE INICIAL DA REPACTUACAO
						@DT_PROX_RPAC
						,-- DATA DA PROXIMA REPACTUACAO
						@RF_BASE_CALC
						,-- DATA BASE DE CALCULO DO TITULO
						@IDX_PC
						,-- PERCENTUAL DO INDEXADOR
						@FER_CHAVE
						,-- POSICAO PARA FERIADOS
						@EH_FUNDO
						,-- FLAG PARA FUNDO OU NAO
						@CETIP_SELIC
						,-- 'C'ETIP PARA PRIVADOS OU 'S'ELIC PARA PUBLICOS
						@ATV_PRZ_PGJUROS
						,-- PRAZO DE PAGAMENTO DE JUROS PARA NTNs E NBC-Es
						@ATV_LOTE
						,-- NOMINAL DO TITULO PARA NTNs E NBC-Es
						@CTB_CURVA
						,-- CURVA DE CONTABILIZACAO
						@RFX_RESULTADO
						,-- FORMA DE CALCULO DA CURVA MERCADO
						@SGL_MEDA
						,-- SIGLA DA MOEDA APC
						@IC_CEN_VCMT
						,-- INDICADOR DE CENARIO DO VENCIMENTO
						@IDX_GERENCIAL
						,-- INDEXADOR GERENCIAL PARA PU MANUAL
						@ATV_IDX_CUSTO
						,-- INDEXADOR DE CUSTO PARA MTM PRE
						@MERC_DT_AQUIS
						,-- INDICADOR DE CALCULO DO CENARIO EM DATA DE AQUISICAO
						@TIR_U
						,-- TIR UTEIS
						@TIR_C
						,-- TIR CORRIDOS
						@RFS_CORRECAO OUTPUT
						,-- VARIACAO PARA O CALCULO DA CORRECAO
						@RFS_PU_UTEIS OUTPUT
						,-- RETORNA O PU UTEIS
						@RFS_PU_CORRIDOS OUTPUT
						,-- RETORNA O PU CORRIDOS
						@RFS_PU_MERCADO OUTPUT
						,-- RETORNA O PU MERCADO
						@RFSC_VALOR OUTPUT
						,-- RETORNA A ULTIMA COTACAO
						@TIR_M OUTPUT
						,-- RETORNA A TIR MERCADO
						@DT_ACABOU_CEN OUTPUT
						,-- RETORNA A DATA QUE ACABOU O CENARIO
						@ERRO OUTPUT
						,-- RETORNA 0 QUANDO ERRO
						@ERR_MSG OUTPUT
						,-- MENSAGEM DE ERRO
						NULL
						,-- CALCULO PELO SQL
						@V_PZ_MDIO_CALD OUTPUT
						,-- PRAZO MEDIO DA OPERACAO
						@V_DURT_CALD OUTPUT
						,-- DURATION DA OPERACAO
						@FL_DESCAP
						,-- DESCAP. POR 252/360
						@FL_IDX_CONTABIL -- CALC. FATOR CORRECAO POR UTEIS/CORRIDOS

						IF EXISTS (
								SELECT 1
								FROM tempdb..sysobjects (NOLOCK)
								WHERE name = '##TMP_CALC_JUROS'
								)
						BEGIN
							IF @DT_CALC = '2019-06-09'
							BEGIN
								
								PRINT 'RF0888 - MARCIO 1 '
								SELECT @RFS_CORRECAO RFS_CORRECAO
								SELECT @RFS_PU_UTEIS RFS_PU_UTEIS
								SELECT * FROM SANT651_RF_SALDOS_EVENTO WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA AND RFS_DATA = '2019-06-09'

							END
						END
				END

				IF @RFS_PU_MERCADO_00 <> 0
				BEGIN
					SET @RFS_PU_MERCADO = @RFS_PU_MERCADO_00
				END

				IF @ERRO <> - 1
				BEGIN
					IF @RETORNA_MSG <> 'S'
						RAISERROR 70001 @ERR_MSG
					ELSE
						SELECT @MENSAGEM_ERRO = @ERR_MSG

					RETURN
				END
			END

			--------------------------------------------------------------------------
			-- ARMAZENAMOS AQUI A CORRECAO DO DIA SEGUNDO O PU DE ABERTURA		--
			--------------------------------------------------------------------------
			IF @PFPJ_APELIDO_EMPRESA = 'SAFRABM'
				AND @ATV_CODIGO = 'CRI'
				AND @RF_AGENTE = 'SAFRA SEC'
			BEGIN
				SELECT @RFS_CORRECAO = @FLOAT0

				----------------------------------------------------------------------------------
				-- CALCULO DO PU DIA POR AGIO/DESAGIO CONFORME O PADRAO CONTABIL EXISTENTE HOJE --
				-- NO BANCO SAFRA - NAO DEVEMOS USAR A TAXA DA CARTEIRA PARA A CURVA CONTABIL	--
				----------------------------------------------------------------------------------
				-- PU DA CURVA NA DATA DE AQUISICAO
				SELECT @PU_CURVA_AQUIS = RFS_PU_CORRIDOS
				FROM RF_SALDOS(NOLOCK)
				WHERE RF_CARACTERISTICA IN (
						SELECT RF_CARACTERISTICA
						FROM RENDA_FIXA
						WHERE TITULO_ID = @TITULO_ID
							AND PFPJ_APELIDO_EMPRESA = 'SAFRA SEC'
						)
					AND RFS_DATA = @DT_AQUIS

				-- PU DA CURVA NA DATA DE CALCULO
				SELECT @PU_CURVA_ATUAL = RFS_PU_CORRIDOS
				FROM RF_SALDOS(NOLOCK)
				WHERE RF_CARACTERISTICA IN (
						SELECT RF_CARACTERISTICA
						FROM RENDA_FIXA
						WHERE TITULO_ID = @TITULO_ID
							AND PFPJ_APELIDO_EMPRESA = 'SAFRA SEC'
						)
					AND RFS_DATA = @DT_CALC

				----------------------------------------
				-- CALCULO DO PU DIA POR AGIO/DESAGIO --
				----------------------------------------
				IF @PU_CURVA_AQUIS > @PU_AQUIS
				BEGIN
					SELECT @RFS_PU_CORRIDOS = ((POWER(@PU_CURVA_AQUIS / @PU_AQUIS, CONVERT(FLOAT, DATEDIFF(DAY, @DT_AQUIS, @DT_CALC)) / CONVERT(FLOAT, DATEDIFF(DAY, @DT_AQUIS, @TIT_VENCTO))) - @FLOAT1) * @PU_AQUIS) + (@PU_CURVA_ATUAL - @PU_CURVA_AQUIS) + @PU_AQUIS
				END
				ELSE
				BEGIN
					DECLARE @RFS_PU_CORRIDOS_BEFORE FLOAT

					SELECT @RFS_PU_CORRIDOS_BEFORE = @RFS_PU_CORRIDOS

					SELECT @RFS_PU_CORRIDOS = ((POWER(@PU_CURVA_AQUIS / @PU_AQUIS, CONVERT(FLOAT, DATEDIFF(DAY, @DT_AQUIS, @DT_CALC)) / CONVERT(FLOAT, DATEDIFF(DAY, @DT_AQUIS, @TIT_VENCTO))) - @FLOAT1) * @PU_CURVA_AQUIS) + (@PU_CURVA_ATUAL - @PU_CURVA_AQUIS) + @PU_AQUI
S

					UPDATE SANT651_RF_SALDOS_EVENTO
					SET V_PRST_EVE = V_PRST_EVE * @RFS_PU_CORRIDOS / @RFS_PU_CORRIDOS_BEFORE
					WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
						AND CTB_CURVA = (
							SELECT CTB_CURVA
							FROM RENDA_FIXA
							WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
							)
						AND RFS_DATA = @DT_CALC

					SELECT @RFS_PU_CORRIDOS = SUM(V_PRST_EVE)
					FROM SANT651_RF_SALDOS_EVENTO(NOLOCK)
					WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
						AND CTB_CURVA = (
							SELECT CTB_CURVA
							FROM RENDA_FIXA
							WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
							)
						AND RFS_DATA = @DT_CALC
				END

				-- ARMAZENA O PU CONTABIL DA ABERTURA DO DIA
				-- UTILIZAMOS POSTERIORMENTE PARA CALCULO DO JUROS DO DIA
				IF @CTB_CURVA = 'M'
					SELECT @V_PU_CTBL_ABERTURA = @RFS_PU_MERCADO
				ELSE IF @CTB_CURVA = 'U'
					SELECT @V_PU_CTBL_ABERTURA = @RFS_PU_UTEIS
				ELSE
					SELECT @V_PU_CTBL_ABERTURA = @RFS_PU_CORRIDOS
			END

			----------------------------------------------------------------------------
			--------------------- INICIO TRATAMENTO PU MEDIO ---------------------------
			----------------------------------------------------------------------------
			IF @PFPJ_APELIDO_EMPRESA = 'SAFRABM'
				AND @ATV_CODIGO = 'CRI'
				AND @RFS_QTDE_C > @FLOAT0
				AND @RF_AGENTE = 'SAFRA SEC'
			BEGIN
				-- INICIALMENTE VAMOS CALCULAR O PU MEDIO SOMENTE PARA CRI NA SAFRABM
				IF (ABS(@RFS_QTDE) + ABS(@RFS_QTDE_C)) > @FLOAT0
				BEGIN
					----------------------------------------------------------
					-- A = COMPRA (AQUISICAO/APLICACAO) - @RFS_FIN_C	--
					-- C = VENDA - @RFS_FIN_V				--
					----------------------------------------------------------
					SELECT @PU_MEDIO_C = ISNULL((ABS(@RFS_QTDE * @RFS_PU_CORRIDOS) + ABS(@RFS_FIN_C)) / (ABS(@RFS_QTDE) + ABS(@RFS_QTDE_C)), @FLOAT0)

					SELECT @PU_MEDIO_U = ISNULL((ABS(@RFS_QTDE * @RFS_PU_UTEIS) + ABS(@RFS_FIN_C)) / (ABS(@RFS_QTDE) + ABS(@RFS_QTDE_C)), @FLOAT0)
				END
				ELSE
				BEGIN
					SELECT @PU_MEDIO_C = ABS(@RFS_FIN_C) / ABS(@RFS_QTDE_C)
						,@PU_MEDIO_U = @PU_MEDIO_C
				END

				-- PU DE AQUISICAO MUDA NA DATA DE CALCULO DO PU MEDIO
				SELECT @DT_AQUIS_ANT = @DT_AQUIS

				SELECT @PU_AQUIS = @PU_MEDIO_C
					,@DT_AQUIS = @DT_CALC

				IF @RFX_RESULTADO <> '006'
					OR @EH_FUNDO = 'S'
				BEGIN
					-- CALCULA A NOVA TAXA SEGUNDO O PU MEDIO
					EXEC SANPP_RF_CALC_TIR_DIA @RF_CARACTERISTICA
						,-- OPERACAO A SER CALCULADA OU CODIGO DE CONTROLE
						@DT_CALC
						,-- DATA EM QUE A TIR ESTA SENDO CALCULADA
						@TITULO_ID
						,-- IDENTIFICADOR DO TITULO
						@ID_RPAC
						,-- IDENTIFICADOR DO PERIODO DE REPACTUACAO OU ZERO PARA PADRONIZADOS
						@IC_OPRC_NAO_PADR
						,-- INDICADOR DE OPERACAO NAO PADRONIZADA
						@TIT_EMISSAO
						,-- EMISSAO DO TITULO
						@TIT_VENCTO
						,-- VENCIMENTO DO TITULO
						@TIT_CUPOM
						,-- CUPOM DO TITULO
						@RFX_FCALC
						,-- FORMA DE CALCULO DE JUROS
						@FCALC_CUPOM
						,-- FORMA DE CALCULO DO CUPOM
						@IDX_CODIGO
						,-- INDEXADOR DE CORRECAO
						@DT_CALC
						,-- DATA DE AQUISICAO DO TITULO
						@DT_INIC_RPAC
						,-- DATA INICIAL DA REPACTUACAO OU EMISSAO PARA PADRONIZADOS
						@DT_PROX_RPAC
						,-- DATA DA PROXIMA REPACTUACAO
						@PU_MEDIO_C
						,-- PU DE AQUISICAO DO TITULO OU DA REPACTUACAO
						@PMIO_AQUIS
						,-- PREMIO DADO NA BOLETAGEM NPDR OU ZERO NOS DEMAIS CASOS
						@V_PU_PMIO
						,-- PREMIO DADO NA REPACTUACAO NPDR OU ZERO NOS DEMAIS CASOS
						@RF_BASE_CALC
						,-- DATA BASE DE CALCULO DO TITULO
						@IDX_PC
						,-- PERCENTUAL DO INDEXADOR
						@FER_CHAVE
						,-- POSICAO PARA FERIADOS
						@CETIP_SELIC
						,-- 'C'ETIP PARA PRIVADOS OU 'S'ELIC PARA PUBLICOS
						@ATV_PRZ_PGJUROS
						,-- PRAZO DE PAGAMENTO DE JUROS PARA NTNs E NBC-Es
						@ATV_LOTE
						,-- NOMINAL DO TITULO PARA NTNs E NBC-Es
						@TIR_U OUTPUT
						,-- RETORNA A TIR UTEIS
						@TIR_C OUTPUT
						,-- RETORNA A TIR CORRIDOS
						@ERRO OUTPUT
						,-- RETORNA 0 QUANDO ERRO
						@ERR_MSG OUTPUT
						,-- MENSAGEM DE ERRO
						NULL
						,-- NAO RETORNA RECORDSET
						@FL_DESCAP
						,-- DESCAP. POR 252/360
						@FL_IDX_CONTABIL -- CALC. FATOR CORRECAO POR UTEIS/CORRIDOS
				END

				-- APAGAMOS A SALDO EVENTO PARA ATUALIZARMOS O VALOR DOS EVENTOS SEGUNDO A NOVA TAXA MEDIA
				DELETE
				FROM SANT651_RF_SALDOS_EVENTO
				WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
					AND RFS_DATA = @DT_CALC

				-- CHAMO PARA ATUALIZAR O SALDO EVENTO PARA A NOVA TAXA MEDIA
				EXEC SANPP_RF_CALC_PU_DIA @RF_CARACTERISTICA
					,-- OPERACAO A SER CALCULADA.
					@DT_CALC
					,-- DATA DE CALCULO DO PU
					@TITULO_ID
					,-- IDENTIFICADOR DO TITULO
					@ID_RPAC
					,-- IDENTIFICADOR DO PERIODO DE REPACTUACAO OU ZERO PARA PADRONIZADOS
					@IC_OPRC_NAO_PADR
					,-- INDICADOR DE OPERACAO NAO PADRONIZADA
					@TIT_EMISSAO
					,-- EMISSAO DO TITULO
					@TIT_VENCTO
					,-- VENCIMENTO DO TITULO
					@TIT_CUPOM
					,-- CUPOM DO TITULO
					@RFX_FCALC
					,-- FORMA DE CALCULO DE JUROS
					@FCALC_CUPOM
					,-- FORMA DE CALCULO DO CUPOM
					@IDX_CODIGO
					,-- INDEXADOR DE CORRECAO
					@DT_AQUIS
					,-- DATA DE AQUISICAO DO TITULO
					@DT_INIC_RPAC
					,-- DATA DE INICIAL DA REPACTUACAO
					@DT_PROX_RPAC
					,-- DATA DA PROXIMA REPACTUACAO
					@RF_BASE_CALC
					,-- DATA BASE DE CALCULO DO TITULO
					@IDX_PC
					,-- PERCENTUAL DO INDEXADOR
					@FER_CHAVE
					,-- POSICAO PARA FERIADOS
					@EH_FUNDO
					,-- FLAG PARA FUNDO OU NAO
					@CETIP_SELIC
					,-- 'C'ETIP PARA PRIVADOS OU 'S'ELIC PARA PUBLICOS
					@ATV_PRZ_PGJUROS
					,-- PRAZO DE PAGAMENTO DE JUROS PARA NTNs E NBC-Es
					@ATV_LOTE
					,-- NOMINAL DO TITULO PARA NTNs E NBC-Es
					@CTB_CURVA
					,-- CURVA DE CONTABILIZACAO
					@RFX_RESULTADO
					,-- FORMA DE CALCULO DA CURVA MERCADO
					@SGL_MEDA
					,-- SIGLA DA MOEDA APC
					@IC_CEN_VCMT
					,-- INDICADOR DE CENARIO DO VENCIMENTO
					@IDX_GERENCIAL
					,-- INDEXADOR GERENCIAL PARA PU MANUAL
					@ATV_IDX_CUSTO
					,-- INDEXADOR DE CUSTO PARA MTM PRE
					@MERC_DT_AQUIS
					,-- INDICADOR DE CALCULO DO CENARIO EM DATA DE AQUISICAO
					@TIR_U
					,-- TIR UTEIS
					@TIR_C
					,-- TIR CORRIDOS
					@RFS_CORRECAO_TEMP OUTPUT
					,-- VARIACAO PARA O CALCULO DA CORRECAO
					@RFS_PU_UTEIS OUTPUT
					,-- RETORNA O PU UTEIS
					@RFS_PU_CORRIDOS OUTPUT
					,-- RETORNA O PU CORRIDOS
					@RFS_PU_MERCADO OUTPUT
					,-- RETORNA O PU MERCADO
					@RFSC_VALOR OUTPUT
					,-- RETORNA A ULTIMA COTACAO
					@TIR_M OUTPUT
					,-- RETORNA A TIR MERCADO
					@DT_ACABOU_CEN OUTPUT
					,-- RETORNA A DATA QUE ACABOU O CENARIO
					@ERRO OUTPUT
					,-- RETORNA 0 QUANDO ERRO
					@ERR_MSG OUTPUT
					,-- MENSAGEM DE ERRO
					NULL
					,-- CALCULO PELO SQL
					@V_PZ_MDIO_CALD OUTPUT
					,-- PRAZO MEDIO DA OPERACAO
					@V_DURT_CALD OUTPUT
					,-- DURATION DA OPERACAO
					@FL_DESCAP
					,-- DESCAP. POR 252/360
					@FL_IDX_CONTABIL -- CALC. FATOR CORRECAO POR UTEIS/CORRIDOS

				SELECT @RFS_PU_CORRIDOS = @PU_MEDIO_C
					,@RFS_PU_UTEIS = @PU_MEDIO_U
					,@RFS_PU_MERCADO = @PU_MEDIO_C

				-- SEPARA AS TAXAS UTEIS E CORRIDOS
				IF @RFX_FCALC IN (
						'009'
						,'022'
						,'036'
						)
					SELECT @RFS_TAXA_MEDIA = @TIR_U
						,@RFS_TAXA_MEDIA_U = @TIR_C
				ELSE
					SELECT @RFS_TAXA_MEDIA = @TIR_C
						,@RFS_TAXA_MEDIA_U = @TIR_U
			END

			----------------------------------------------------------------------------
			--------------------- FIM TRATAMENTO PU MEDIO    ---------------------------
			----------------------------------------------------------------------------
			---------------------------------------------------------------------------
			-- Cleber - 02/10/2006							 --
			-- Proc SANPP_RF_CALC_PU_DIA nao retorna os valores de PU para o dia do  --
			-- vencimento. Nao gerava os valores de juros e correcao para o ultimo   --
			-- dia. Buscamos o valor do PU e correcao na SANT644_RF_AGENDA_EVENTO.   --
			---------------------------------------------------------------------------
			-- Liana - 07/07/2010
			-- O PU já está vindo correto para não padronizadas na RF0884.prc
			---------------------------------------------------------------------------
			IF @IC_OPRC_NAO_PADR = 'S'
				AND @TIT_VENCTO <= @DT_CALC
			BEGIN
				-- se tem pagto juros no dia do vencto, então zera o PU
				IF @PGT_JUROS > 0
				BEGIN
					SELECT @RFS_PU_CORRIDOS = 0
						,@RFS_PU_UTEIS = 0
						,@RFS_PU_MERCADO = 0
				END

				-- 			SELECT 	@RFS_PU_CORRIDOS = ISNULL(SUM(V_PU_CALD),@FLOAT0)
				-- 			FROM	SANT644_RF_AGENDA_EVENTO
				-- 			WHERE	TITULO_ID	=  @TITULO_ID	AND
				-- 				ID_RPAC		=  @ID_RPAC	AND
				-- 				DT_EVE		=  @DT_CALC
				-- 
				-- 			SELECT	@RFS_PU_UTEIS = @RFS_PU_CORRIDOS,
				-- 				@RFS_PU_MERCADO = @RFS_PU_CORRIDOS
				---- Aluisio - 09/06/2010
				SELECT @FL_ARRED = B.IC_ARRD_CTP
					,@PU_CASAS = B.Q_DEC_PU
					,@PU_ARRED = CASE B.IC_TRUNC_DEC_PU
						WHEN 'S'
							THEN @TRUNCA
						ELSE @ARREDONDA
						END
				FROM RF_TITULO A(NOLOCK)
					,CODIGO_TITULO B(NOLOCK)
				WHERE A.ATV_CODIGO = B.ATV_CODIGO
					AND A.IDX_CODIGO = B.IDX_CODIGO
					AND A.LOCAL_NEGOCIACAO = B.LOCAL_NEGOCIACAO
					AND B.IC_ARRD_CTP = 'S'
					AND TITULO_ID = @TITULO_ID
					AND CD_TIT IN (
						6000
						,6001
						,6500
						)

				IF @FL_ARRED = 'S'
					SELECT @RFS_PU_CORRIDOS = ROUND(@RFS_PU_CORRIDOS, @PU_CASAS, @PU_ARRED)
						,@RFS_PU_UTEIS = ROUND(@RFS_PU_UTEIS, @PU_CASAS, @PU_ARRED)
						,@RFS_PU_MERCADO = ROUND(@RFS_PU_MERCADO, @PU_CASAS, @PU_ARRED)
						---fim
			END

			-- 03/10/2005 - OC. 4809
			-- APURA O PU MERCADO DE ACORDO COM RFX_RESULTADO
			IF @RFX_RESULTADO = '005' --CORRIDOS
				SELECT @RFS_PU_MERCADO = @RFS_PU_CORRIDOS
			ELSE IF @RFX_RESULTADO = '007' --UTEIS
				SELECT @RFS_PU_MERCADO = @RFS_PU_UTEIS

			-- APURA O PU DE APROPRIACAO
			IF @CTB_CURVA = 'M'
				SELECT @V_PU_CTBL = @RFS_PU_MERCADO
			ELSE IF @CTB_CURVA = 'U'
				SELECT @V_PU_CTBL = @RFS_PU_UTEIS
			ELSE
				SELECT @V_PU_CTBL = @RFS_PU_CORRIDOS

			-- SE A DATA DE CALCULO FOR MUDANCA DE PERIODO DE REPACTUACAO,
			-- IGUALA OS PUS E RECALCULA UMA NOVA TIR.
			IF @IC_OPRC_NAO_PADR = 'S'
				AND @DT_CALC = @DT_FIM_RPAC
			BEGIN
				IF @DT_CALC > @TIT_VENCTO
					SELECT @DATA = @TIT_VENCTO
				ELSE
					SELECT @DATA = @DT_CALC

				-- SE A DATA DE CALCULO FOR A DATA DE VENCIMENTO DO TITULO NO PERIODO VIGENTE
				-- E EXISTIR REPACTUACAO APOS O VENCIMENTO, ADOTAR O NOMINAL DEVIDO COMO PU NO PONTO.
				IF @DATA = @TIT_VENCTO
					AND EXISTS (
						SELECT TOP 1 TITULO_ID
						FROM SANT643_RF_REPAC_TITULO(NOLOCK)
						WHERE TITULO_ID = @TITULO_ID
							AND ID_RPAC > @ID_RPAC
							AND @DATA BETWEEN DT_INIC_RPAC
								AND DT_FIM_RPAC
						)
				BEGIN
					SELECT @V_PU_CTBL = SUM(B.V_PU_AMTC)
					FROM SANT643_RF_REPAC_TITULO A(NOLOCK)
						,SANT644_RF_AGENDA_EVENTO B(NOLOCK)
					WHERE A.TITULO_ID = @TITULO_ID
						AND A.ID_RPAC > @ID_RPAC
						AND A.TITULO_ID = B.TITULO_ID
						AND A.ID_RPAC = B.ID_RPAC
						AND B.ID_T_EVE = 4
						AND -- EVENTO DE AMORTIZACAO
						@DATA BETWEEN A.DT_INIC_RPAC
							AND A.DT_FIM_RPAC
				END

				-- BUSCA OS DADOS DA REPACTUACAO
				SELECT @IDX_CODIGO = B.IDX_CODIGO
					,@TIT_VENCTO = B.DT_VCMT
					,@TIT_CUPOM = B.V_TXA_RPAC
					,@ATV_FCVALORIZ = B.ATV_FCVALORIZ
					,@ID_RPAC = B.ID_RPAC
					,@IDX_PC = B.IDX_PC
					,@DT_INIC_RPAC = B.DT_INIC_RPAC
					,@DT_FIM_RPAC = B.DT_FIM_RPAC
					,@DT_PROX_RPAC = B.DT_FIM_RPAC
					,@V_PU_PMIO = B.V_PU_PMIO
					,@RFX_FCALC = B.FC_JUROS
					,@RF_BASE_CALC = B.RF_BASE_CALC
					,@IC_EVE_CORC_TIT = ISNULL(B.IC_EVE_CORC_TIT, 'N')
					,@V_PU_CORC = ISNULL(B.V_PU_CORC, 0)
				FROM RF_TITULO A(NOLOCK)
					,SANT643_RF_REPAC_TITULO B(NOLOCK)
				WHERE A.TITULO_ID = @TITULO_ID
					AND A.TITULO_ID = B.TITULO_ID
					AND @DATA BETWEEN B.DT_INIC_RPAC
						AND B.DT_FIM_RPAC

				IF @@ROWCOUNT = 0
				BEGIN
					SELECT @ERR_MSG = @RF_CARACTERISTICA + ': NAO EXISTE REPACTUACAO. TITULO_ID: ' + RTRIM(CONVERT(CHAR, @TITULO_ID)) + '. DATA: ' + CONVERT(CHAR(10), @DT_CALC, 103)

					IF @RETORNA_MSG <> 'S'
						RAISERROR 70001 @ERR_MSG
					ELSE
						SELECT @MENSAGEM_ERRO = @ERR_MSG

					RETURN
				END

				-- Somente para titulos que NÃO são calculo manual (RFX_RESULTADO = '006')
				-- By Charlie - 10/06/2019
				IF NOT EXISTS (
						SELECT 1
						FROM RF_INDEXACAO
						WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
							AND RFX_RESULTADO = '006'
						)
				BEGIN
					-- Por causa do descasamento da data de vencimento com a data de liquidação do evento
					-- a valorização tem que usar como vencimento o último DT_EVE dos fluxos
					-- By Charlie - 18/06/2015
					IF EXISTS (
							SELECT 1
							FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
							WHERE TITULO_ID = @TITULO_ID
								AND ID_RPAC = @ID_RPAC
							)
					BEGIN
						SELECT @TIT_VENCTO = MAX(DT_EVE)
						FROM SANT644_RF_AGENDA_EVENTO
						WHERE TITULO_ID = @TITULO_ID
							AND ID_RPAC = @ID_RPAC
					END
				END

				-- A REPACTUACAO SEMPRE EXPIRA NA PROXIMA RESERVA
				EXEC SIAN_SP_PROXIMA_RESERVA 'A'
					,@FER_CHAVE
					,@DT_FIM_RPAC OUTPUT
					,0

				-- SE EXISTIR PERIODO POSTERIOR, AJUSTAR A DATA DA PROXIMA REPACTUACAO
				IF EXISTS (
						SELECT ID_RPAC
						FROM SANT643_RF_REPAC_TITULO(NOLOCK)
						WHERE TITULO_ID = @TITULO_ID
							AND ID_RPAC > @ID_RPAC
						)
				BEGIN
					SELECT @DT_PROX_RPAC = DATEADD(Day, 1, @DT_PROX_RPAC)
				END

				-- SE O PROXIMO ID FOR CORRECAO, BUSCA A DATA DA PROXIMA REPACTUACAO
				IF (
						SELECT IC_EVE_CORC_TIT
						FROM SANT643_RF_REPAC_TITULO(NOLOCK)
						WHERE TITULO_ID = @TITULO_ID
							AND ID_RPAC = @ID_RPAC
						) = 'S'
				BEGIN
					-- BUSCA A DATA INICIAL DA PROXIMA REPACTUACAO OU O VENCTO DO TITULO
					SELECT @DT_PROX_RPAC = DT_INIC_RPAC
					FROM SANT643_RF_REPAC_TITULO(NOLOCK)
					WHERE TITULO_ID = @TITULO_ID
						AND ID_RPAC = (
							SELECT MIN(ID_RPAC)
							FROM SANT643_RF_REPAC_TITULO(NOLOCK)
							WHERE TITULO_ID = @TITULO_ID
								AND ID_RPAC > @ID_RPAC
								AND IC_EVE_CORC_TIT = 'N'
							)

					IF @@ROWCOUNT = 0
						SELECT @DT_PROX_RPAC = @TIT_VENCTO
				END

				-- VERIFICA A FORMA DE CALCULO DO CUPOM
				SELECT @FCALC_CUPOM = CASE 
						WHEN IDX_TIPO = 'M'
							AND @TIT_EMISSAO > @DT20000801
							THEN '033'
						WHEN IDX_TIPO = 'M'
							OR (
								IDX_TIPO = 'I'
								AND @CETIP_SELIC = 'S'
								)
							THEN '013'
						ELSE @RFX_FCALC
						END
					,@IDX_FCALC = IDX_FCALC
					,@IDX_PRE = IDX_PRE
					,@IDX_TIPO = IDX_TIPO
				FROM INDEXADOR(NOLOCK)
				WHERE IDX_CODIGO = @IDX_CODIGO

				-- SE FOR UM EVENTO DE CORRECAO, VERIFICA SE FOI DIGITADO O PU DE CORRECAO
				IF @IC_EVE_CORC_TIT = 'S'
					AND @V_PU_CORC <> 0
					SELECT @V_PU_CTBL = @V_PU_CORC

				-- ATUALIZA OS PUS NA DATA DE REPACTUACAO
				SELECT @RFS_PU_UTEIS = @V_PU_CTBL
					,@RFS_PU_CORRIDOS = @V_PU_CTBL
					,@RFS_PU_MERCADO = @V_PU_CTBL

				-- SE MUDOU O PERIODO
				IF @DT_FIM_RPAC > @DT_CALC
				BEGIN
					IF @RFX_RESULTADO <> '006'
						OR @EH_FUNDO = 'S'
					BEGIN
						-- RF0886.PRC
						EXEC SANPP_RF_CALC_TIR_DIA @RF_CARACTERISTICA
							,-- OPERACAO A SER CALCULADA OU CODIGO DE CONTROLE
							@DT_CALC
							,-- DATA EM QUE A TIR ESTA SENDO CALCULADA
							@TITULO_ID
							,-- IDENTIFICADOR DO TITULO
							@ID_RPAC
							,-- IDENTIFICADOR DO PERIODO DE REPACTUACAO OU ZERO PARA PADRONIZADOS
							@IC_OPRC_NAO_PADR
							,-- INDICADOR DE OPERACAO NAO PADRONIZADA
							@TIT_EMISSAO
							,-- EMISSAO DO TITULO
							@TIT_VENCTO
							,-- VENCIMENTO DO TITULO
							@TIT_CUPOM
							,-- CUPOM DO TITULO
							@RFX_FCALC
							,-- FORMA DE CALCULO DE JUROS
							@FCALC_CUPOM
							,-- FORMA DE CALCULO DO CUPOM
							@IDX_CODIGO
							,-- INDEXADOR DE CORRECAO
							@DT_INIC_RPAC
							,-- DATA DE INICIO DA REPACTUACAO
							@DT_INIC_RPAC
							,-- DATA INICIAL DA REPACTUACAO OU EMISSAO PARA PADRONIZADOS
							@DT_PROX_RPAC
							,-- DATA DA PROXIMA REPACTUACAO
							@V_PU_CTBL
							,-- PU DE REPACTUACAO DO TITULO
							@PMIO_AQUIS
							,-- PREMIO DADO NA BOLETAGEM NPDR OU ZERO NOS DEMAIS CASOS
							@V_PU_PMIO
							,-- PREMIO DADO NA REPACTUACAO NPDR OU ZERO NOS DEMAIS CASOS
							@RF_BASE_CALC
							,-- DATA BASE DE CALCULO DO TITULO
							@IDX_PC
							,-- PERCENTUAL DO INDEXADOR
							@FER_CHAVE
							,-- POSICAO PARA FERIADOS
							@CETIP_SELIC
							,-- 'C'ETIP PARA PRIVADOS OU 'S'ELIC PARA PUBLICOS
							@ATV_PRZ_PGJUROS
							,-- PRAZO DE PAGAMENTO DE JUROS PARA NTNs E NBC-Es
							@ATV_LOTE
							,-- NOMINAL DO TITULO PARA NTNs E NBC-Es
							@TIR_U OUTPUT
							,-- RETORNA A TIR UTEIS
							@TIR_C OUTPUT
							,-- RETORNA A TIR CORRIDOS
							@ERRO OUTPUT
							,-- RETORNA 0 QUANDO ERRO
							@ERR_MSG OUTPUT -- MENSAGEM DE ERRO

						IF @RFX_FCALC IN (
								'009'
								,'022'
								,'036'
								)
							SELECT @TIR_M = @TIR_U
						ELSE
							SELECT @TIR_M = @TIR_C

						IF @ERRO <> - 1
						BEGIN
							IF @RETORNA_MSG <> 'S'
								RAISERROR 70001 @ERR_MSG
							ELSE
								SELECT @MENSAGEM_ERRO = @ERR_MSG

							RETURN
						END
					END
				END
			END

			-- SEPARA AS TAXAS UTEIS E CORRIDOS
			IF @RFX_FCALC IN (
					'009'
					,'022'
					,'036'
					)
				SELECT @RFS_TAXA_MEDIA = @TIR_U
					,@RFS_TAXA_MEDIA_U = @TIR_C
			ELSE
				SELECT @RFS_TAXA_MEDIA = @TIR_C
					,@RFS_TAXA_MEDIA_U = @TIR_U

			--------------------------------------------------------------------------
			-- INVERTEMOS A ORDEM DA BAIXA DE PRINCIPAL PARA CALCULO O CALCULO 	--
			-- CORRETO DO PRINCIPAL MEDIO 						--
			-- PRIMEIRO - BAIXAMOS O PRINCIPAL COM BASE NO PRINCIPAL DE FEC DE D-1 	--
			-- SEGUNDO - CALCULAMOS O NOVO PRINCIPAL DO DIA	DESC. AS BAIXAS		--
			--------------------------------------------------------------------------
			IF @ATV_FCVALORIZ = '008'
			BEGIN
				EXEC @EH_RESERVA = SIAN_E_RESERVA @DT_CALC
					,'A'
					,@FER_CHAVE
					,0

				-- 			IF  @EH_FUNDO = 'S'
				-- 			BEGIN
				IF @EH_RESERVA = - 1 -- SE FOR DIA UTIL VERIFICA O PAGAMENTO DE PRINCIPAL=
					-- 					SELECT
					-- 						@RFS_PRINCIPAL	= @RFS_PRINCIPAL - (V_PU_AMTC * @RFS_QTDE)
					-- 					FROM
					-- 						SANT644_RF_AGENDA_EVENTO
					-- 					WHERE
					-- 						TITULO_ID	=	@TITULO_ID	AND
					-- 						ID_RPAC		=	@ID_RPAC	AND
					-- 						ID_T_EVE	=	@EVE_AMTC_PCPL	AND -- EVENTO DE AMORTIZACAO
					-- 						DT_EVE		>	@DT_UTIL	AND
					-- 						DT_EVE		<=	@DT_CALC
					-- SELECT ISNULL(MAX(DT_EVE), '19000101') FROM SANT644_RF_AGENDA_EVENTO WHERE ID_T_EVE = @EVE_AMTC_PCPL AND TITULO_ID = @TITULO_ID AND DT_EVE <= @DT_AQUIS
					-- KUBA - 05/12/2016 - EXCLUÍDO DO TRATAMENTO AS DEBENTURES E DEB INCENTIVADAS
					SELECT @DT_PRIM_AMORT = ISNULL(MIN(DT_EVE), '21000101')
					FROM SANT644_RF_AGENDA_EVENTO
					WHERE ID_T_EVE = @EVE_AMTC_PCPL
						AND TITULO_ID = @TITULO_ID
						AND DT_EVE > @DT_AQUIS

				--IF @DT_CALC = @DT_AQUIS AND @ATV_CODIGO NOT IN ('LCA', 'LCA FGC', 'DEBENTURES', 'DEBENTURES INCT') -- KUBA- 02/12/2016 - RETIRA TRATAMENTO PARA DEBENTURES
				--			SELECT @RFS_PRINCIPAL = 0
				IF @DT_CALC < @DT_PRIM_AMORT
				BEGIN
					-- 					SELECT
					-- 						@RFS_PRINCIPAL	= @RFS_PRINCIPAL + (@ATV_LOTE - ISNULL(SUM(V_PU_AMTC), 0)) * ABS(@RFS_QTDE + @RFS_QTDE_C - @RFS_QTDE_V)
					-- 					FROM
					-- 						SANT644_RF_AGENDA_EVENTO
					-- 					WHERE
					-- 						TITULO_ID	=	@TITULO_ID	AND
					-- 						ID_RPAC		=	@ID_RPAC	AND
					-- 						ID_T_EVE	=	@EVE_AMTC_PCPL	AND -- EVENTO DE AMORTIZACAO
					-- --						DT_EVE		>	@DT_UTIL	AND
					-- 						DT_EVE		<=	@DT_CALC
					SELECT @RFS_PRINCIPAL = @RFS_PRINCIPAL
				END
				ELSE
				BEGIN
					SELECT
						-------------------------------------------------------------------------------------------------------------------------------
						--					Liana - Conforme definição do Jurídico, deve-se deduzir as amortizações do Principal.
						-------------------------------------------------------------------------------------------------------------------------------
						--						@RFS_PRINCIPAL	= (@ATV_LOTE - ISNULL(SUM(V_PU_AMTC), 0)) * ABS(@RFS_QTDE + @RFS_QTDE_C - @RFS_QTDE_V)
						@RFS_PRINCIPAL = (@PU_AQUIS - ISNULL(SUM(V_PU_AMTC), 0)) * ABS(@RFS_QTDE + @RFS_QTDE_C - @RFS_QTDE_V)
					FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
					WHERE TITULO_ID = @TITULO_ID
						AND ID_RPAC = @ID_RPAC
						AND ID_T_EVE = @EVE_AMTC_PCPL
						AND -- EVENTO DE AMORTIZACAO
						DBO.SANFS_RV_PROXIMA_RESERVA('SAFRABM', 'A', DBO.SANFS_RV_RESERVA_ANTERIOR('SAFRABM', 'A', DT_EVE)) > @DT_AQUIS
						AND DT_EVE <= @DT_CALC -- KUBA - 03/02/2017 - UTILIZAR DATA CORRIDA E NÃO ÚTIL PARA CALCULAR O TOTAL DE AMORTIZAÇÃO

				END

				--SELECT @RFS_PRINCIPAL RFS_PRINCIPAL, @DT_CALC DT_CALC, @DT_AQUIS DT_AQUIS,  @DT_PRIM_AMORT DT_PRIM_AMORT
				-- 			END
				-- 			ELSE
				-- 			BEGIN
				-- 				IF @RFS_PRINCIPAL > 0
				-- 				BEGIN
				-- 					IF @PFPJ_APELIDO_EMPRESA = 'SAFRA SEC' OR @PFPJ_APELIDO_EMPRESA = 'SAFRA SEC CART'
				-- 						-- PARA SAFRA SEC E SAFRA SEC CART O PRINCIPAL DEVE SER BAIXADO PELO EVENTO DE AMORTIZACAO DA AGENDA EVENTO
				-- 						SELECT
				-- 							-- ????
				-- 							@RFS_PRINCIPAL	= @RFS_PRINCIPAL - (ISNULL(V_PU_AMTC,@FLOAT0) * @QTDE_SALDO) -- ???? @RFS_QTDE)
				-- 						FROM
				-- 							SANT644_RF_AGENDA_EVENTO   (NOLOCK) 
				-- 						WHERE
				-- 							TITULO_ID	=	@TITULO_ID	AND
				-- 							ID_RPAC		=	@ID_RPAC	AND
				-- 							ID_T_EVE	=	@EVE_AMTC_PCPL	AND -- EVENTO DE AMORTIZACAO
				-- 							DT_EVE		=	@DT_CALC
				-- 					ELSE
				-- 						----------------------------------------------------------------------------------
				-- 						--  PARA SAFRABM E CLIENTES O PRINCIPAL DEVE SER AMORTIZADO PELO VALOR PRESENTE --
				-- 						-- DE TODOS OS EVENTOS NA DATA DA AQUISICAO DO PAPEL OU DATA DE CALCULO DO ULT- --
				-- 						-- MO PU MEDIO.									--
				-- 						----------------------------------------------------------------------------------
				-- 						SELECT  @RFS_PRINCIPAL	= @RFS_PRINCIPAL - (ISNULL(SUM(V_PRST_EVE),@FLOAT0) * @RFS_QTDE)
				-- 						FROM	SANT651_RF_SALDOS_EVENTO   (NOLOCK) 
				-- 						WHERE	DT_EVE			=	@DT_CALC AND
				-- 							RF_CARACTERISTICA 	= 	@RF_CARACTERISTICA AND
				-- 							RFS_DATA 		= 	@DT_AQUIS_ANT
				-- 				END
				-- 			END
				-- BUSCA O VALOR DE PAGAMENTO DOS EVENTOS NO DIA
				-- *** UTILIZADO NO CALCULO DO FATOR ACUMULADO ***
				SELECT @PU_PGTO_JUROS = ISNULL(SUM(V_PU_CALD), 0)
				FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
				WHERE TITULO_ID = @TITULO_ID
					AND ID_RPAC = @ID_RPAC
					AND DT_EVE <= @DT_CALC
					AND DT_EVE > @DT_UTIL
					AND DT_EVE <> @DT_AQUIS
			END
			ELSE IF @PGT_JUROS > @RFS_JUROS
				AND @RFS_JUROS >= 0
				AND @CTB_CURVA <> 'M'
				SELECT @RFS_PRINCIPAL = @RFS_PRINCIPAL - (@PGT_JUROS - @RFS_JUROS)

			----------------------------------------------------------------------------
			--------------------- INICIO TRATAMENTO PRINCIPAL MEDIO --------------------
			----------------------------------------------------------------------------

			IF @PFPJ_APELIDO_EMPRESA = 'SAFRABM'
				AND @ATV_CODIGO = 'CRI'
				AND @RF_AGENTE = 'SAFRA SEC'
			BEGIN
				IF (ABS(@RFS_QTDE) + ABS(@RFS_QTDE_C)) > @FLOAT0
					SELECT @RFS_PRINCIPAL = (ISNULL((ABS(ISNULL(@RFS_PRINCIPAL, @FLOAT0)) + ABS(@RFS_FIN_C)) / (ABS(@RFS_QTDE) + ABS(@RFS_QTDE_C)), @FLOAT0)) * @QTDE_SALDO
						--ELSE
						--SELECT 	@RFS_PRINCIPAL = ABS(@RFS_FIN_C)
						----------------------------------------------------------------------------
						--------------------- FIM TRATAMENTO PRINCIPAL MEDIO -----------------------
						----------------------------------------------------------------------------
			END
			ELSE
			BEGIN
				-- ATUALIZA O PRINCIPAL E O FINANCEIRO DE AQUISICAO
				IF @ATV_AP = 'A'
					AND NOT (
						@TIPO_ESTOQUE = '08'
						AND @RFM_DT_INI = 'C'
						) -- Liana - 12/01/2010
				BEGIN
					--SELECT @RFS_PRINCIPAL RFS_PRINCIPAL
					SELECT @RFS_PRINCIPAL = @RFS_PRINCIPAL + @RFS_FIN_C
						--SELECT @RFS_PRINCIPAL RFS_PRINCIPAL
						-- 					SELECT
						-- 						@RFS_PRINCIPAL	= @RFS_PRINCIPAL + (@ATV_LOTE - ISNULL(SUM(V_PU_AMTC), 0)) * ABS(@RFS_QTDE + @RFS_QTDE_C - @RFS_QTDE_V)
						-- 					FROM
						-- 						SANT644_RF_AGENDA_EVENTO
						-- 					WHERE
						-- 						TITULO_ID	=	@TITULO_ID	AND
						-- 						ID_RPAC		=	@ID_RPAC	AND
						-- 						ID_T_EVE	=	@EVE_AMTC_PCPL	AND -- EVENTO DE AMORTIZACAO
						-- --						DT_EVE		>	@DT_UTIL	AND
						-- 						DT_EVE		<=	@DT_CALC
						--SELECT @RFS_PRINCIPAL RFS_PRINCIPAL, @RFS_FIN_C RFS_FIN_C
						PRINT '2'
						SELECT @RFS_PRINCIPAL RFS_PRINCIPAL, '@RFS_PRINCIPAL'
						SELECT @RFS_FIN_C RFS_FIN_C, '@RFS_FIN_C'
				END
				ELSE
					SELECT @RFS_PRINCIPAL = @RFS_PRINCIPAL + @RFS_FIN_V
				
				PRINT '3'
				PRINT @RFS_PRINCIPAL
				-- VERIFICA O QUANTO AS VENDAS IMPACTARAM NO PRINCIPAL
				IF (@RFS_QTDE + @RFS_QTDE_C) > @FLOAT0
					SELECT @RFS_PRINCIPAL = @RFS_PRINCIPAL * (1 - (@RFS_QTDE_V / (@RFS_QTDE + @RFS_QTDE_C)))

				--PASSIVO - EMISSAO DA LEASING
				IF (@RFS_QTDE + @RFS_QTDE_V) > @FLOAT0
					AND (
						@ATV_AP = 'P'
						OR (
							@TIPO_ESTOQUE = '08'
							AND @RFM_DT_INI = 'C'
							)
						) -- Liana - 12/01/2010
					SELECT @RFS_PRINCIPAL = @RFS_PRINCIPAL * (1 - (@RFS_QTDE_C / (@RFS_QTDE + @RFS_QTDE_V)))
			END


			IF EXISTS (
				SELECT 1
				FROM tempdb..sysobjects (NOLOCK)
				WHERE name = '##TMP_CALC_JUROS'
				)
			BEGIN
				IF @DT_CALC = '2019-06-09'
				BEGIN							
					PRINT 'RF0888 - MARCIO - 1 - CALCULA JUROS E CORRECAOL'													
				END
			END

			-- CALCULA JUROS E CORRECAO
			IF @RFS_QTDE <> @FLOAT0
			BEGIN
				IF @EH_FUNDO = 'S'
					SELECT @RFS_CORRECAO = @FLOAT1
				ELSE IF @IDX_TIPO = 'T'
					SELECT @RFS_CORRECAO = @FLOAT0

				IF @EH_FUNDO <> 'S'
					AND @IC_OPRC_NAO_PADR <> 'S'
				BEGIN
					SELECT @CORRECAO_AQUIS = @RFS_QTDE * (@VAR_AQUIS - @FLOAT1) * @ATV_LOTE

					SELECT @CORRECAO_AQUIS = CONVERT(MONEY, @CORRECAO_AQUIS)

					EXEC TRUNC @CORRECAO_AQUIS
						,2
						,@CORRECAO_AQUIS OUTPUT
				END

				---------------------------------------------------------------------------
				-- Cleber - 02/10/2006							 --
				-- Separacao do juros e atualizacao para as posicoes contabeis 		 --
				-- diferentes de fundos.						 --
				---------------------------------------------------------------------------
				IF @EH_FUNDO = 'S'
				BEGIN
					SELECT @RFS_CORRECAO = @RFS_QTDE * (@RFS_CORRECAO - @FLOAT1) * @ATV_LOTE - @CORRECAO_AQUIS

					/*DANILO 03/11/2006: Para Fundos, manter o calculo do Juros sobre o Saldo Abertura */
					SELECT @RFS_JUROS = (@V_PU_CTBL * @RFS_QTDE) - @PRINCIPAL_ABERTURA - @RFS_CORRECAO
				END
				ELSE IF @IC_OPRC_NAO_PADR = 'S'
				BEGIN
					-- 11/12/2006
					IF @DT_CALC <= @TIT_VENCTO
						OR @EH_FUNDO = 'S'
					BEGIN
						IF @IDX_TIPO = 'T'
							SELECT @RFS_CORRECAO = @FLOAT0
						ELSE
						BEGIN
							------------------------------------------
							-- CORRECAO NA DATA DE VENCIMENTO	--
							------------------------------------------
							IF @TIT_VENCTO = @DT_CALC
							BEGIN
								------------------------------------------------------------------------
								-- NO DIA DO VENCIMENTO DO TITULO, O VALOR DA CORRECAO EH A DIFERENCA --
								-- ENTRE O VALOR EFETIVAMENTE PAGO NA AGENDA EVENTO, CONTRA O VALOR   --
								-- DO SALDO EVENTO DO DIA ANTERIOR				      --
								------------------------------------------------------------------------
								SELECT @RFS_CORRECAO = ISNULL((ISNULL(SUM(B.V_PU_CALD), @FLOAT0) - ISNULL(SUM(A.V_FUT_EVE), @FLOAT0)) + ISNULL(@RFS_CORRECAO_ANT / (
												CASE 
													WHEN ISNULL(@RFS_QTDE, @FLOAT0) = 0
														THEN 1
													ELSE @RFS_QTDE
													END
												), @FLOAT0), @FLOAT0)
								FROM SANT651_RF_SALDOS_EVENTO A(NOLOCK)
									,-- DIA ANTERIOR
									SANT644_RF_AGENDA_EVENTO B(NOLOCK) -- DIA ATUAL
								WHERE A.RF_CARACTERISTICA = @RF_CARACTERISTICA
									AND a.CTB_CURVA = (
										SELECT CTB_CURVA
										FROM RENDA_FIXA
										WHERE RF_CARACTERISTICA = A.RF_CARACTERISTICA
										)
									AND B.TITULO_ID = @TITULO_ID
									AND A.ID_T_EVE IN (
										@EVE_CORC_PCPL
										,@EVE_CORC_AMTC
										)
									AND A.RFS_DATA = DATEADD(Day, - 1, @DT_CALC)
									AND B.ID_T_EVE = A.ID_T_EVE
									AND B.DT_EVE = A.DT_EVE
									AND A.DT_EVE >= @DT_CALC
							END
									------------------------------------------
									-- CORRECAO NOS DEMAIS DIAS		--
									------------------------------------------
							ELSE
							BEGIN
								SELECT @RFS_CORRECAO_PAGA = @FLOAT0

								---------------------------------------------------------
								-- APURA O QUANTO FOI PAGO DE CORRECAO NO DIA ANTERIOR --
								-- CONTRA A DATA DE AQUISICAO.			       --
								---------------------------------------------------------
								SELECT @RFS_CORRECAO_PAGA = ISNULL(ISNULL(SUM(A.V_PU_CALD), @FLOAT0) - ISNULL(SUM(B.V_FUT_EVE), @FLOAT0), @FLOAT0)
								FROM SANT644_RF_AGENDA_EVENTO A(NOLOCK)
									,SANT651_RF_SALDOS_EVENTO B(NOLOCK)
								WHERE A.TITULO_ID = @TITULO_ID
									AND b.CTB_CURVA = (
										SELECT CTB_CURVA
										FROM RENDA_FIXA
										WHERE RF_CARACTERISTICA = b.RF_CARACTERISTICA
										)
									AND A.ID_RPAC = @ID_RPAC
									AND A.DT_EVE = DATEADD(Day, - 1, @DT_CALC)
									AND A.ID_T_EVE IN (
										@EVE_CORC_PCPL
										,@EVE_CORC_AMTC
										)
									AND B.ID_T_EVE = A.ID_T_EVE
									AND B.DT_EVE = A.DT_EVE
									AND B.RF_CARACTERISTICA = @RF_CARACTERISTICA
									AND B.RFS_DATA = @DT_AQUIS_ANT

								-------------------------------------------------------------------------------------------
								-- PARA O SAFRABM TEM AQUE SER A CORRECAO ANTES DO CALCULO DO PU MEDIO, O PU DE ABERTURA --
								-------------------------------------------------------------------------------------------
								IF @PFPJ_APELIDO_EMPRESA <> 'SAFRABM'
								BEGIN
									-- 								select 	@RFS_CORRECAO = ISNULL((SUM(B.V_FUT_EVE) - SUM(A.V_FUT_EVE)) +
									-- 											(ISNULL(@RFS_CORRECAO_ANT/(CASE WHEN ISNULL(@RFS_QTDE,@FLOAT0) = 0
									-- 															THEN 1
									-- 															ELSE @RFS_QTDE END),@FLOAT0)),@FLOAT0)
									-- 								from 	SANT651_RF_SALDOS_EVENTO A  (NOLOCK), -- DIA ANTERIOR
									-- 									SANT651_RF_SALDOS_EVENTO B  (NOLOCK)  -- DIA ATUAL
									-- 								where 	A.RF_CARACTERISTICA = @RF_CARACTERISTICA
									-- 								and	A.ID_T_EVE IN (@EVE_CORC_PCPL,@EVE_CORC_AMTC)
									-- 								and	A.RFS_DATA = DATEADD(Day, -1, @DT_CALC)
									-- 								and	B.RF_CARACTERISTICA = A.RF_CARACTERISTICA
									-- 								and	B.ID_T_EVE = A.ID_T_EVE
									-- 								and	B.DT_EVE = A.DT_EVE -- NAO CONSIDERA A DO DIA
									-- 								and	B.RFS_DATA = @DT_CALC
									-- 								and	A.DT_EVE >= @DT_CALC
									SELECT @RFS_CORRECAO = ISNULL((SUM(B.V_FUT_EVE) - SUM(A.V_FUT_EVE)) + (
												ISNULL(@RFS_CORRECAO_ANT / (
														CASE 
															WHEN ISNULL(@RFS_QTDE, @FLOAT0) = 0
																THEN 1
															ELSE @RFS_QTDE
															END
														), @FLOAT0)
												), @FLOAT0)
									FROM (
										SELECT SUM(A.V_FUT_EVE) V_FUT_EVE
										FROM SANT651_RF_SALDOS_EVENTO A(NOLOCK) -- DIA ANTERIOR
										WHERE A.RF_CARACTERISTICA = @RF_CARACTERISTICA
											AND a.CTB_CURVA = (
												SELECT CTB_CURVA
												FROM RENDA_FIXA
												WHERE RF_CARACTERISTICA = a.RF_CARACTERISTICA
												)
											AND A.ID_T_EVE IN (
												@EVE_CORC_PCPL
												,@EVE_CORC_AMTC
												)
											AND A.RFS_DATA = DATEADD(Day, - 1, @DT_CALC)
										) a
										,(
											SELECT SUM(B.V_FUT_EVE) V_FUT_EVE
											FROM SANT651_RF_SALDOS_EVENTO B(NOLOCK) -- DIA ATUAL
											WHERE B.RF_CARACTERISTICA = @RF_CARACTERISTICA
												AND b.CTB_CURVA = (
													SELECT CTB_CURVA
													FROM RENDA_FIXA
													WHERE RF_CARACTERISTICA = b.RF_CARACTERISTICA
													)
												AND B.ID_T_EVE IN (
													@EVE_CORC_PCPL
													,@EVE_CORC_AMTC
													)
												AND B.RFS_DATA = @DT_CALC
											) b

									-- CONSIDERA A CORRECAO PAGA NO DIA
									IF (
											SELECT ID_T_ATC_NOML
											FROM RF_TITULO(NOLOCK)
											WHERE TITULO_ID = @TITULO_ID
											) <> 4
										AND EXISTS (
											SELECT A.TITULO_ID
											FROM SANT644_RF_AGENDA_EVENTO A(NOLOCK)
											WHERE A.TITULO_ID = @TITULO_ID
												AND A.ID_RPAC = @ID_RPAC
												AND A.DT_EVE = @DT_CALC
												AND A.ID_T_EVE IN (
													@EVE_CORC_PCPL
													,@EVE_CORC_AMTC
													)
											)
										SELECT @RFS_CORRECAO = @RFS_CORRECAO + (ISNULL(SUM(A.V_PU_CALD), @FLOAT0) - ISNULL(SUM(B.V_FUT_EVE), @FLOAT0))
										FROM SANT644_RF_AGENDA_EVENTO A(NOLOCK)
											,SANT651_RF_SALDOS_EVENTO B(NOLOCK)
										WHERE A.TITULO_ID = @TITULO_ID
											AND b.CTB_CURVA = (
												SELECT CTB_CURVA
												FROM RENDA_FIXA
												WHERE RF_CARACTERISTICA = b.RF_CARACTERISTICA
												)
											AND A.ID_RPAC = @ID_RPAC
											AND A.DT_EVE = @DT_CALC
											AND A.ID_T_EVE IN (
												@EVE_CORC_PCPL
												,@EVE_CORC_AMTC
												)
											AND B.RF_CARACTERISTICA = @RF_CARACTERISTICA
											AND B.RFS_DATA = DATEADD(Day, - 1, @DT_CALC)
											AND B.DT_EVE = @DT_CALC
											AND B.ID_T_EVE = A.ID_T_EVE
								END
							END
						END

						SELECT @RFS_PGTO_DIA = @FLOAT0

						-- SE NAO DESEJARMOS APROPRIAR CORRECAO E JUROS NO DIA DA VENDA/RECOMPRA SUBSTITUIR @RFS_QTDE POR @QTDE_SALDO
						IF @PFPJ_APELIDO_EMPRESA = 'SAFRABM'
							AND @ATV_CODIGO = 'CRI'
							AND @RF_AGENTE = 'SAFRA SEC'
						BEGIN
							-- JA CALCULO O PU CONTABIL SOMANDO O PAGAMENTO DO DIA
							IF @TIT_VENCTO <> @DT_CALC
								SELECT @RFS_PGTO_DIA = ISNULL(SUM(V_PU_CALD), @FLOAT0)
								FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
								WHERE TITULO_ID = @TITULO_ID
									AND ID_RPAC = @ID_RPAC
									AND DT_EVE = @DT_CALC

							SELECT @RFS_CORRECAO = @FLOAT0

							IF @DT_CALC = @TIT_VENCTO
								SELECT @RFS_JUROS = ((@V_PU_CTBL_ABERTURA) * @RFS_QTDE) - @PRINCIPAL_ABERTURA - ROUND(@RFS_CORRECAO, 2, 1)
							ELSE
								SELECT @RFS_JUROS = ((@V_PU_CTBL_ABERTURA + @RFS_PGTO_DIA) * @RFS_QTDE) - @PRINCIPAL_ABERTURA - ROUND(@RFS_CORRECAO, 2, 1)
						END
						ELSE
						BEGIN
							/**************************************************************************************
						-- KUBA - 21/11/2016 - DESCONTA PAGAMENTO DE JUROS			   
						**************************************************************************************/
							IF @TIT_VENCTO <> @DT_CALC
								AND @ATV_CODIGO IN (
									'DEBENTURES'
									,'DEBENTURES INCT'
									)
							BEGIN
								EXEC @EH_RESERVA = SIAN_E_RESERVA @DT_CALC
									,'A'
									,@FER_CHAVE
									,0

								-- CASO NÃO SEJA DIA ÚTIL, RECUPERA DIA ÚTIL ANTERIOR
								SELECT @DT_REF_PG = @DT_CALC

								IF @EH_RESERVA = 0
									EXEC SIAN_SP_RESERVA_ANTERIOR @FER_CHAVE
										,'A'
										,@DT_REF_PG OUTPUT
										,0

								SELECT @RFS_PGTO_DIA = ISNULL(SUM(V_PU_CALD), @FLOAT0)
								FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
								WHERE TITULO_ID = @TITULO_ID
									AND ID_RPAC = @ID_RPAC
									AND DT_EVE <= @DT_REF_PG
									AND DT_EVE >= @DT_REF_PG_INI
									AND ID_T_EVE <> @EVE_AMTC_PCPL

								-- KUBA - 03/02/2017 - CASO HAJA AMORTIZAÇÃO NO DIA, DESCONSIDERAR DO PU NO CÁLCULO DE JUROS APROPRIADOS
								SELECT @V_PU_AMTC_DIA = ISNULL(SUM(V_PU_AMTC), @FLOAT0)
								FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
								WHERE TITULO_ID = @TITULO_ID
									AND ID_RPAC = @ID_RPAC
									AND DT_EVE = @DT_CALC
									AND ID_T_EVE = @EVE_AMTC_PCPL
							END

							
							/**************************************************************************************
							-- FIM			   
							**************************************************************************************/
							SELECT @RFS_CORRECAO = (@RFS_CORRECAO - @RFS_CORRECAO_PAGA) * @RFS_QTDE

							-- KUBA 05/12/2016
							IF @FL_TIR_RECALCULADA = 'S'
								SELECT @RFS_JUROS = ((@RFS_PU_C_ABERTURA_00 + @RFS_PGTO_DIA) * @RFS_QTDE) - @PRINCIPAL_ABERTURA - ROUND(@RFS_CORRECAO, 2, 1)
							ELSE -- KUBA 03/01/2017 - No cálculo do juros incluir pu de amortização do dia
								SELECT @RFS_JUROS = ((@V_PU_CTBL + @RFS_PGTO_DIA + @V_PU_AMTC_DIA) * @RFS_QTDE) - @PRINCIPAL_ABERTURA - ROUND(@RFS_CORRECAO, 2, 1)

							IF EXISTS (
								SELECT 1
								FROM tempdb..sysobjects (NOLOCK)
								WHERE name = '##TMP_CALC_JUROS'
								)
							BEGIN
								IF @DT_CALC = '2019-06-09'
								BEGIN		
									SELECT @FL_TIR_RECALCULADA FL_TIR_RECALCULADA, '@FL_TIR_RECALCULADA'
									SELECT @V_PU_CTBL V_PU_CTBL, '@@V_PU_CTBL' 
									SELECT @RFS_PGTO_DIA RFS_PGTO_DIA, '@RFS_PGTO_DIA'
									SELECT @V_PU_AMTC_DIA V_PU_AMTC_DIA, '@V_PU_AMTC_DIA'
									SELECT @RFS_CORRECAO RFS_CORRECAO, '@RFS_CORRECAO'
									SELECT @PRINCIPAL_ABERTURA PRINCIPAL_ABERTURA , '@PRINCIPAL_ABERTURA'
								END
							END
						END
					END
					ELSE
					BEGIN
						SELECT @RFS_CORRECAO = @FLOAT0
							,@RFS_JUROS = @FLOAT0
					END
				END
				ELSE
				BEGIN
					SELECT @RFS_CORRECAO = @RFS_QTDE * (@RFS_CORRECAO - @FLOAT1) * @ATV_LOTE - @CORRECAO_AQUIS

					SELECT @RFS_JUROS = (@V_PU_CTBL * @RFS_QTDE) - @PRINCIPAL_ABERTURA - @RFS_CORRECAO
				END

				---------------------------------------------------------------------------
				SELECT @RFS_CORRECAO = CONVERT(MONEY, @RFS_CORRECAO)
					,@RFS_JUROS = CONVERT(MONEY, @RFS_JUROS)

				EXEC TRUNC @RFS_JUROS
					,2
					,@RFS_JUROS OUTPUT

				EXEC TRUNC @RFS_CORRECAO
					,2
					,@RFS_CORRECAO OUTPUT

				-- APURA O JUROS E CORRECAO CONTABIL
				IF @EH_FUNDO = 'S'
					AND @ESTOQUE_ORI = '00'
					AND @CTB_CURVA <> 'C'
				BEGIN
					EXEC @EH_RESERVA = SIAN_E_RESERVA @DT_CALC
						,'A'
						,@FER_CHAVE
						,0

					IF @EH_RESERVA = - 1 -- DIA UTIL
					BEGIN
						--REGICAU - 11/12/2017
						SELECT @V_RFM_PU_PAGTO_JUROS = 0

						SELECT @V_TRANSF_CARTADM = 'N'

						SELECT @V_DT_TRANSF_CARTADM = '1900-01-01'

						IF EXISTS (
								SELECT 1
								FROM FDO_POSICAO_FUNDO WITH (NOLOCK)
								WHERE POS_APELIDO = @PFPJ_APELIDO_EMPRESA
									AND IC_CART_ADMD = 'S'
								)
						BEGIN
							SELECT @V_RFM_PU_PAGTO_JUROS = B.RFM_PU
							FROM RENDA_FIXA A(NOLOCK)
							INNER JOIN RF_MOVIMENTACAO B(NOLOCK) ON B.RF_CARACTERISTICA = A.RF_CARACTERISTICA
							WHERE A.RF_CARACTERISTICA = @RF_CARACTERISTICA
								AND A.PFPJ_APELIDO_EMPRESA = @PFPJ_APELIDO_EMPRESA
								AND A.TITULO_ID = @TITULO_ID
								AND B.RFM_DATA = @DT_CALC
								AND B.RFM_DT = 'B'
								AND B.RFM_OK = 'S'

							--REGICAU - 11/12/2017
							IF EXISTS (
									SELECT 1
									FROM SANT085_RF_TRANSFER_CAC A WITH (NOLOCK)
									INNER JOIN PF_PJ B WITH (NOLOCK) ON B.PFPJ_CODIGO_KADU = A.CD_CAC_DTIN
									WHERE B.PFPJ_APELIDO = @PFPJ_APELIDO_EMPRESA
										AND A.IC_CART_ADM = 'L'
									)
							BEGIN
								SELECT @V_TRANSF_CARTADM = 'S'

								SELECT @V_DT_TRANSF_CARTADM = DBO.SANFS_RF_BUSCA_DT_TRANSF_CARTADM(@RF_CARACTERISTICA)

								IF @V_DT_TRANSF_CARTADM IS NULL
									SELECT @V_DT_TRANSF_CARTADM = '1900-01-01'
							END
						END

						--DANILO 09/01/2007: Para Fundos, o Juros contábil e Juros Anterior devem ser sempre sobre o Saldo Abertura (Projetos NTN-F e COFI)
						SELECT @V_CORC_CTBL = @FLOAT0
							,@V_CORC_CTBL_ANTR = @FLOAT0
							,@V_JURS_CTBL = ((@RFS_QTDE) * (@RFS_PU_UTEIS + @V_RFM_PU_PAGTO_JUROS)) - @PRINCIPAL_ABERTURA
							,--REGICAU - 11/12/2017 - INCLUSAO DA VARIAVEL @V_RFM_PU_PAGTO_JUROS
							@V_JURS_CTBL_ANTR = ((@RFS_QTDE) * @RFS_PU_UTEIS_ANT) - @PRINCIPAL_ABERTURA

						--REGICAU - 11/12/2017
						IF @V_TRANSF_CARTADM = 'S'
						BEGIN
							IF @DT_CALC <= CONVERT(DATETIME, @V_DT_TRANSF_CARTADM)
								SELECT @V_JURS_CTBL_ANTR = @V_JURS_CTBL
						END
					END
					ELSE
						SELECT @V_CORC_CTBL = @FLOAT0
							,@V_JURS_CTBL = @FLOAT0
							,@V_CORC_CTBL_ANTR = @FLOAT0
							,@V_JURS_CTBL_ANTR = @FLOAT0
				END
				ELSE
					SELECT @V_CORC_CTBL = @RFS_CORRECAO
						,@V_JURS_CTBL = @RFS_JUROS
						,@V_CORC_CTBL_ANTR = @RFS_CORRECAO_ANT
						,@V_JURS_CTBL_ANTR = @RFS_JUROS_ANT
			END
			ELSE
				SELECT @RFS_CORRECAO = @FLOAT0
					,@RFS_JUROS = @FLOAT0
					,@V_CORC_CTBL = @FLOAT0
					,@V_JURS_CTBL = @FLOAT0
					,@RFS_JUROS_ANT = @FLOAT0 /*DANILO 03/11/2006: Zera o Juros anterior, caso nao haja mais saldo em aberto */

			IF EXISTS (
				SELECT 1
				FROM tempdb..sysobjects (NOLOCK)
				WHERE name = '##TMP_CALC_JUROS'
				)
			BEGIN
				IF @DT_CALC = '2019-06-09'
				BEGIN							
					PRINT 'FIM' 
				END
			END



			EXEC TRUNC @V_CORC_CTBL
				,2
				,@V_CORC_CTBL OUTPUT

			EXEC TRUNC @V_JURS_CTBL
				,2
				,@V_JURS_CTBL OUTPUT

			EXEC TRUNC @V_CORC_CTBL_ANTR
				,2
				,@V_CORC_CTBL_ANTR OUTPUT

			EXEC TRUNC @V_JURS_CTBL_ANTR
				,2
				,@V_JURS_CTBL_ANTR OUTPUT

			-- APURA O RESULTADO FISCAL
			IF @PFPJ_APELIDO_EMPRESA = 'SAFRABM'
				AND @ATV_CODIGO = 'L H'
				AND @RFS_QTDE_C > @FLOAT0
				SELECT @RFS_RESULTADO = ((@RFS_FIN_C / @RFS_QTDE_C) - @V_PU_CTBL) * @RFS_QTDE_C
			ELSE IF @RFS_QTDE_V <> @FLOAT0
				AND @DT_CALC <> @TIT_VENCTO
				SELECT @RFS_RESULTADO = ((@RFS_FIN_V / @RFS_QTDE_V) - @V_PU_CTBL) * @RFS_QTDE_V

			-- CALCULA OS IMPOSTOS
			-- Liana - 14/07/2010 - Alteração para papéis com pagto juros
			SELECT @RFS_PRINCIPAL_ANT = RFS_PRINCIPAL
			FROM RF_SALDOS(NOLOCK)
			WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
				AND RFS_DATA = DATEADD(Day, - 1, @DT_CALC)

			--		SELECT   @RFS_PRINCIPAL_ANT '@RFS_PRINCIPAL_ANT',  @DT_CALC '@DT_CALC',  @RFS_IOF '@RFS_IOF', @RFS_PRINCIPAL '@RFS_PRINCIPAL'
			SELECT @FIN_APROPRIACAO = @QTDE_SALDO * @V_PU_CTBL
				,
				--			@FIN_PARTIDA	 = (@QTDE_SALDO * @PU_AQUIS) + @RFS_IOF,
				@FIN_ABE_APROP = @RFS_QTDE * @V_PU_CTBL
				,
				--			@FIN_ABE_PARTIDA = (@RFS_QTDE * @PU_AQUIS) + @RFS_IOF
				@FIN_ABE_PARTIDA = @RFS_PRINCIPAL_ANT + @RFS_IOF

			IF @DT_CALC >= @TIT_VENCTO
			BEGIN
				SELECT @FIN_PARTIDA = @RFS_PRINCIPAL_ANT + @RFS_IOF
			END
			ELSE
			BEGIN
				SELECT @FIN_PARTIDA = @RFS_PRINCIPAL + @RFS_IOF
			END

			--		SELECT  @FIN_PARTIDA '@FIN_PARTIDA', @FIN_ABE_PARTIDA '@FIN_ABE_PARTIDA'
			-- TRUNCA OU ARREDONDA O PRINCIPAL, O RESULTADO E OS FINANCEIROS
			IF @FIN_TRUNCA = 'S'
			BEGIN
				EXEC TRUNC @RFS_PRINCIPAL
					,2
					,@RFS_PRINCIPAL OUTPUT

				EXEC TRUNC @FIN_APROPRIACAO
					,2
					,@FIN_APROPRIACAO OUTPUT

				EXEC TRUNC @FIN_PARTIDA
					,2
					,@FIN_PARTIDA OUTPUT

				EXEC TRUNC @FIN_ABE_APROP
					,2
					,@FIN_ABE_APROP OUTPUT

				EXEC TRUNC @FIN_ABE_PARTIDA
					,2
					,@FIN_ABE_PARTIDA OUTPUT
			END
			ELSE
				SELECT @RFS_PRINCIPAL = ROUND(@RFS_PRINCIPAL, 2)
					,@FIN_APROPRIACAO = ROUND(@FIN_APROPRIACAO, 2)
					,@FIN_PARTIDA = ROUND(@FIN_PARTIDA, 2)
					,@FIN_ABE_APROP = ROUND(@FIN_ABE_APROP, 2)
					,@FIN_ABE_PARTIDA = ROUND(@FIN_ABE_PARTIDA, 2)

			-- RESULTADO ARREDONDADO NA 2ª CASA
			SELECT @RFS_RESULTADO = ROUND(@RFS_RESULTADO, 2)

			-- O PRAZO MEDIO E A DURATION SAO TRUNCADAS NA 6ª CASA
			EXEC TRUNC @V_PZ_MDIO_CALD
				,6
				,@V_PZ_MDIO_CALD OUTPUT

			EXEC TRUNC @V_DURT_CALD
				,6
				,@V_DURT_CALD OUTPUT

			-- IOF DE RESGATE
			--		IF @RF_TRIB_IOF = 'S'
			IF @RF_TRIB_IOF = 'N'
				AND RTRIM(@ATV_CODIGO) NOT IN (
					'LCA'
					,'LCA FGC'
					,'L H'
					,'CRI'
					,'LCI'
					,'CRA'
					) -- Liana - 19/07 - Mercadorias isentas de IOF
			BEGIN
				-- MARCELO GONZAGA 26/11/2013
				-- PARA 'DEBENTURES INCT'   SO' EXECUTA  SIAN_VALOR_IOF  PARA PESSOA JURIDICA ( PESSOA FISICA E' ISENTO DE IOF )
				IF RTRIM(@ATV_CODIGO) <> 'DEBENTURES INCT'
					OR (
						RTRIM(@ATV_CODIGO) = 'DEBENTURES INCT'
						AND @VCH_TP_F_J = 'J'
						)
				BEGIN
					EXEC SIAN_VALOR_IOF @ATV_RENDA
						,@RFX_PARTIDA
						,@DT_CALC
						,'001'
						,@FIN_PARTIDA
						,@FIN_APROPRIACAO
						,''
						,''
						,@RFS_IOFR OUTPUT
						,1
				END
						-- 			SELECT @CORTE_IOF = CN_PARM FROM SANT515_GE_PARAMETRO WHERE CH_PARM = 'CRT_IOF'
						-- 			IF @DT_CALC >= @CORTE_IOF
						-- 				SELECT @RFS_IOFR = 0
			END

			-- IMPOSTO DE RENDA
			IF (
					@RF_TRIB_IR = 'S'
					OR (
						@RF_TRIB_IR = 'N'
						AND @DT_CALC > @DT19971231
						)
				)
			BEGIN
				SELECT @FIN_PARTIDA = @FIN_PARTIDA + @RFS_IOFR
					,@FIN_ABE_PARTIDA = @FIN_ABE_PARTIDA + @RFS_IOFR

				-- 			SELECT @FIN_PARTIDA '@FIN_PARTIDA',  @RFS_IOFR '@RFS_IOFR'
				-- 			SELECT @FIN_ABE_PARTIDA '@FIN_ABE_PARTIDA',  @RFS_IOFR '@RFS_IOFR'
				-- 25/06/2010 -- IF (@ATV_ISENTO_IR = 'N' OR @DT_CALC < @TIT_VENCTO)
				IF (
						@ATV_ISENTO_IR = 'N'
						OR @DT_CALC <= @TIT_VENCTO
						)
				BEGIN
					IF @RFS_QTDE <> @FLOAT0
					BEGIN
						--					select @DT_CALC '@DT_CALC', @RFS_IR '@RFS_IR - qtde', @FIN_ABE_PARTIDA '@FIN_ABE_PARTIDA', @FIN_ABE_APROP '@FIN_ABE_APROP'
						-- MARCELO GONZAGA 26/11/2013
						-- PARA 'DEBENTURES INCT'   SO' EXECUTA  SANPP_RF_CALC_IR  PARA PESSOA JURIDICA ( PESSOA FISICA E' ISENTO DE IR )
						IF RTRIM(@ATV_CODIGO) <> 'DEBENTURES INCT'
							OR (
								RTRIM(@ATV_CODIGO) = 'DEBENTURES INCT'
								AND @VCH_TP_F_J = 'J'
								)
						BEGIN
							EXEC SANPP_RF_CALC_IR @ATV_RENDA
								,
								--								@FER_CHAVE,
								@PFPJ_APELIDO_EMPRESA
								,@RF_CARACTERISTICA
								,@RFX_PARTIDA
								,@DT_CALC
								,@FIN_ABE_PARTIDA
								,@FIN_ABE_APROP
								,@RF_FCALC_IR
								,@RFS_IR OUTPUT
						END
					END

					IF @QTDE_SALDO <> @FLOAT0
					BEGIN
						--					select  @DT_CALC '@DT_CALC', @RFS_IR '@RFS_IR - qtde saldo', @FIN_PARTIDA, '@FIN_PARTIDA', @FIN_APROPRIACAO '@FIN_APROPRIACAO'
						-- MARCELO GONZAGA 26/11/2013
						-- PARA 'DEBENTURES INCT'   SO' EXECUTA  SANPP_RF_CALC_IR  PARA PESSOA JURIDICA ( PESSOA FISICA E' ISENTO DE IR )
						IF RTRIM(@ATV_CODIGO) <> 'DEBENTURES INCT'
							OR (
								RTRIM(@ATV_CODIGO) = 'DEBENTURES INCT'
								AND @VCH_TP_F_J = 'J'
								)
						BEGIN
							EXEC SANPP_RF_CALC_IR @ATV_RENDA
								,
								--								@FER_CHAVE,
								@PFPJ_APELIDO_EMPRESA
								,@RF_CARACTERISTICA
								,@RFX_PARTIDA
								,@DT_CALC
								,@FIN_PARTIDA
								,@FIN_APROPRIACAO
								,@RF_FCALC_IR
								,@RFS_IR OUTPUT
						END
					END
				END
			END

			--		SELECT @RFS_IR  '@RFS_IR'
			-- CALCULA PROVISAO DIARIA - MARCACAO MERCADO
			IF (
					@TIPO_ESTOQUE = '00'
					OR @ESTOQUE_ORI = '00'
					)
				AND (
					@EH_FUNDO = 'S'
					OR (
						@EH_FUNDO = 'N'
						AND EXISTS (
							SELECT REGR_CHAVE
							FROM REGRA_CONTABIL(NOLOCK)
							WHERE PFPJ_APELIDO_EMPRESA = @PFPJ_APELIDO_EMPRESA
								AND ATV_CODIGO = @ATV_CODIGO
								AND IDX_CODIGO = @IDX_CODIGO
								AND EVEN_CODIGO IN (
									'450'
									,'451'
									)
							)
						)
					)
				EXEC SIAN_RF_VAL_PROVISAO @RF_CARACTERISTICA
					,@DT_CALC
					,@RFS_QTDE
					,@RFS_QTDE_C
					,@RFS_QTDE_V
					,@RFS_PU_MERCADO
					,@RFS_PU_CORRIDOS
					,@RFS_PU_UTEIS
					,@RFS_PROVISAO_DIF OUTPUT
					,@RFS_PROVISAO OUTPUT
					,@RFS_PROVISAO_ANT OUTPUT

			-- CALCULA PROVISAO EM CASO DE TRANSFERENCIA DE CATEGORIA
			IF @TIPO_ESTOQUE = '09'
				EXEC SANPS_RF_PROV_TRANSF @RF_CARACTERISTICA
					,@DT_CALC
					,@RFS_PU_CORRIDOS
					,@RFS_PU_UTEIS
					,@RFS_PU_MERCADO
					,@RFS_PROVISAO_TRANSF OUTPUT
					,@RFS_PROVISAO OUTPUT
					,@RFS_PROVISAO_DIF OUTPUT

			-- CALCULA OS FATORES ACUMULADOS
			IF @RFS_PU_UTEIS_ANT <> @FLOAT0
				SELECT @V_FATR_ACUD_UTES = @V_FATR_ACUD_UTES * ((@RFS_PU_UTEIS + @PU_PGTO_JUROS) / @RFS_PU_UTEIS_ANT)

			IF @RFS_PU_MERC_ANT <> @FLOAT0
				SELECT @V_FATR_ACUD_MERC = @V_FATR_ACUD_MERC * ((@RFS_PU_MERCADO + @PU_PGTO_JUROS) / @RFS_PU_MERC_ANT)

			IF @ATV_AP = 'P'
				OR (
					@TIPO_ESTOQUE = '08'
					AND @RFM_DT_INI = 'C'
					) -- Liana - 12/01/2010
				SELECT @RFS_QTDE = @RFS_QTDE * - 1

			--PAÇOCA VALORIZAÇÃO DO TERMO
			IF @TIPO_ESTOQUE = '08'
			BEGIN
				SELECT @RFS_JUROS = 0
					,@RFS_JUROS_ANT = 0
			END

			IF @TIPO_ESTOQUE <> '08'
				AND @ATV_AP = 'P'
				AND (@RFS_QTDE + @RFS_QTDE_C - @RFS_QTDE_V) > 0.01
			BEGIN
				SELECT @ERR_MSG = 'CARTEIRA COMPRADA! CARAC: ' + @RF_CARACTERISTICA + ', DATA ' + CONVERT(CHAR(10), @DT_CALC, 103) + '.'

				IF @RETORNA_MSG <> 'S'
					RAISERROR 70001 @ERR_MSG
				ELSE
					SELECT @MENSAGEM_ERRO = @ERR_MSG

				RETURN
			END

			IF @TIPO_ESTOQUE <> '08'
				AND @ATV_AP = 'A'
				AND (@RFS_QTDE + @RFS_QTDE_C - @RFS_QTDE_V) < - 0.01
			BEGIN
				SELECT @ERR_MSG = 'CARTEIRA VENDIDA! CARAC: ' + @RF_CARACTERISTICA + ', DATA ' + CONVERT(CHAR(10), @DT_CALC, 103) + '.'

				IF @RETORNA_MSG <> 'S'
					RAISERROR 70001 @ERR_MSG
				ELSE
					SELECT @MENSAGEM_ERRO = @ERR_MSG

				RETURN
			END

			-- GRAVAR RF_SALDOS
			INSERT INTO RF_SALDOS (
				RF_CARACTERISTICA
				,RFS_DATA
				,RFS_QTDE
				,RFS_QTDE_C
				,RFS_QTDE_V
				,RFS_FIN_C
				,RFS_FIN_V
				,RFS_PRINCIPAL
				,RFS_TAXA_MEDIA
				,RFS_PU_UTEIS
				,RFS_PU_CORRIDOS
				,RFS_PU_CUSTO
				,RFS_PU_MERCADO
				,RFS_PU_MERC_ANT
				,RFS_RESULTADO
				,RFS_IOF
				,RFS_IR
				,RFS_IR_ANT
				,RFS_JUROS
				,RFS_JUROS_ANT
				,RFS_CORRECAO
				,RFS_CORRECAO_ANT
				,LC_SITUACAO
				,PGT_JUROS
				,RFS_TAXA_MEDIA_U
				,RFS_APROPRIAR
				,RFS_APROPRIAR_ANT
				,IR_ABERTURA
				,PRINCIPAL_ABERTURA
				,RFS_CORRECAO_ACRU
				,RFS_AGDG_C
				,RFS_AGDG_U
				,RFS_AGDG
				,RFS_AGDG_ANT
				,RFS_IOFR
				,RFS_PROVISAO_ANT
				,RFS_PROVISAO_DIF
				,RFS_PROVISAO
				,RFS_PROVISAO_TRANSF
				,V_JURS_CTBL
				,V_CORC_CTBL
				,V_JURS_CTBL_ANTR
				,V_CORC_CTBL_ANTR
				,V_FATR_ACUD_UTES
				,V_FATR_ACUD_MERC
				,V_PU_CTBL
				,V_PZ_MDIO_CALD
				,V_PZ_MDIO_AJTD
				,V_DURT_CALD
				)
			VALUES (
				@RF_CARACTERISTICA
				,-- 	RF_CARACTERISTICA	CHAR(20)
				@DT_CALC
				,-- 	RFS_DATA		DATETIME
				@RFS_QTDE
				,-- 	RFS_QTDE		FLOAT
				@RFS_QTDE_C
				,-- 	RFS_QTDE_C		FLOAT
				@RFS_QTDE_V
				,-- 	RFS_QTDE_V		FLOAT
				@RFS_FIN_C
				,-- 	RFS_FIN_C		FLOAT
				@RFS_FIN_V
				,-- 	RFS_FIN_V		FLOAT
				@RFS_PRINCIPAL
				,-- 	RFS_PRINCIPAL		FLOAT
				@RFS_TAXA_MEDIA
				,-- 	RFS_TAXA_MEDIA		FLOAT
				@RFS_PU_UTEIS
				,-- 	RFS_PU_UTEIS		FLOAT
				@RFS_PU_CORRIDOS
				,-- 	RFS_PU_CORRIDOS		FLOAT
				@FLOAT0
				,-- 	RFS_PU_CUSTO		FLOAT
				@RFS_PU_MERCADO
				,-- 	RFS_PU_MERCADO		FLOAT
				@RFS_PU_MERC_ANT
				,-- 	RFS_PU_MERC_ANT		FLOAT
				@RFS_RESULTADO
				,-- 	RFS_RESULTADO		FLOAT
				@RFS_IOF
				,-- 	RFS_IOF			FLOAT
				@RFS_IR
				,-- 	RFS_IR			FLOAT
				@RFS_IR_ANT
				,-- 	RFS_IR_ANT		FLOAT
				@RFS_JUROS
				,-- 	RFS_JUROS		FLOAT
				@RFS_JUROS_ANT
				,-- 	RFS_JUROS_ANT		FLOAT
				@RFS_CORRECAO
				,-- 	RFS_CORRECAO		FLOAT
				@RFS_CORRECAO_ANT
				,-- 	RFS_CORRECAO_ANT	FLOAT
				'A'
				,-- 	LC_SITUACAO		CHAR(01)
				@PGT_JUROS
				,-- 	PGT_JUROS		FLOAT
				@RFS_TAXA_MEDIA_U
				,-- 	RFS_TAXA_MEDIA_U	FLOAT
				@FLOAT0
				,-- 	RFS_APROPRIAR		FLOAT
				@FLOAT0
				,-- 	RFS_APROPRIAR_ANT	FLOAT
				@IR_ABERTURA
				,-- 	IR_ABERTURA		FLOAT
				@PRINCIPAL_ABERTURA
				,-- 	PRINCIPAL_ABERTURA	FLOAT
				@FLOAT0
				,-- 	RFS_CORRECAO_ACRU	FLOAT
				@FLOAT0
				,-- 	RFS_AGDG_C		FLOAT
				@FLOAT0
				,-- 	RFS_AGDG_U		FLOAT
				@FLOAT0
				,-- 	RFS_AGDG		FLOAT
				@FLOAT0
				,-- 	RFS_AGDG_ANT		FLOAT
				@RFS_IOFR
				,-- 	RFS_IOFR		FLOAT
				@RFS_PROVISAO_ANT
				,-- 	RFS_PROVISAO_ANT	FLOAT
				@RFS_PROVISAO_DIF
				,-- 	RFS_PROVISAO_DIF	FLOAT
				@RFS_PROVISAO
				,-- 	RFS_PROVISAO		FLOAT
				@RFS_PROVISAO_TRANSF
				,-- 	RFS_PROVISAO_TRANSF	FLOAT
				@V_JURS_CTBL
				,-- 	V_JURS_CTBL		FLOAT
				@V_CORC_CTBL
				,-- 	V_CORC_CTBL		FLOAT
				@V_JURS_CTBL_ANTR
				,-- 	V_JURS_CTBL_ANTR	FLOAT
				@V_CORC_CTBL_ANTR
				,-- 	V_CORC_CTBL_ANTR	FLOAT
				@V_FATR_ACUD_UTES
				,-- 	V_FATR_ACUD_UTES	FLOAT
				@V_FATR_ACUD_MERC
				,-- 	V_FATR_ACUD_MERC	FLOAT
				@V_PU_CTBL
				,--	V_PU_CTBL		FLOAT
				@V_PZ_MDIO_CALD
				,--	V_PZ_MDIO_CALD		FLOAT
				@V_PZ_MDIO_CALD
				,--	V_PZ_MDIO_AJTD		FLOAT
				@V_DURT_CALD --	V_DURT_CALD		FLOAT
				)

			-- GRAVAR RF_SALDOS_COTACAO
			INSERT INTO RF_SALDOS_COTACAO (
				RF_CARACTERISTICA
				,RFSC_DATA
				,RFSC_VALOR
				,RFSC_CENARIO
				,SGL_MEDA
				,RFSC_TAXA
				)
			VALUES (
				@RF_CARACTERISTICA
				,-- 	RF_CARACTERISTICA	CHAR(20)
				@DT_CALC
				,-- 	RFSC_DATA		DATETIME
				@RFSC_VALOR
				,-- 	RFSC_VALOR		FLOAT
				@TIR_M
				,-- 	RFSC_CENARIO		FLOAT
				@SGL_MEDA
				,-- 	SGL_MEDA		CHAR(15)
				@RFS_TAXA_MEDIA -- 	RFSC_TAXA		FLOAT
				)

			SELECT @PU_JUROS_PGTO_DIA = ISNULL(SUM(V_PU_CALD), 0)
			FROM SANT644_RF_AGENDA_EVENTO(NOLOCK)
			WHERE TITULO_ID = @TITULO_ID
				AND ID_RPAC = @ID_RPAC
				AND ID_T_EVE <> @EVE_AMTC_PCPL
				AND -- EVENTO DE AMORTIZACAO
				--						DT_EVE		>	@DT_UTIL	AND
				DT_EVE = @DT_CALC
				AND DT_EVE < @TIT_VENCTO

			--		SELECT @PU_JUROS_PGTO_DIA '@PU_JUROS_PGTO_DIA', @DT_CALC '@DT_CALC'
			IF @ATV_AP = 'A'
				AND NOT (
					@TIPO_ESTOQUE = '08'
					AND @RFM_DT_INI = 'C'
					) -- Liana - 12/01/2010
			BEGIN
				SELECT
					--@RFS_JUROS_ANT	 	= CASE	WHEN @RFS_QTDE_V <> 0 THEN
					--				@RFS_JUROS - (@RFS_JUROS * @RFS_QTDE_V / (@RFS_QTDE + @RFS_QTDE_C))								ELSE @RFS_JUROS
					--			  END,
					@RFS_CORRECAO_ANT = CASE 
						WHEN @RFS_QTDE_V <> 0
							THEN @RFS_CORRECAO - (@RFS_CORRECAO * @RFS_QTDE_V / (@RFS_QTDE + @RFS_QTDE_C))
						ELSE @RFS_CORRECAO
						END
			END
			ELSE
			BEGIN
				SELECT
					--	@RFS_JUROS_ANT	 	= CASE	WHEN @RFS_QTDE_C <> 0 THEN
					--						@RFS_JUROS - (@RFS_JUROS * @RFS_QTDE_C / (@RFS_QTDE + @RFS_QTDE_V))
					--					ELSE
					--						@RFS_JUROS
					--				  END,
					@RFS_CORRECAO_ANT = CASE 
						WHEN @RFS_QTDE_C <> 0
							THEN @RFS_CORRECAO - (@RFS_CORRECAO * @RFS_QTDE_C / (@RFS_QTDE + @RFS_QTDE_V))
						ELSE @RFS_CORRECAO
						END
			END

			-- 		SELECT @RFS_JUROS_ANT '@RFS_JUROS_ANT - ANTES', @DT_CALC '@DT_CALC'
			-- 
			-- 		SELECT ABS(@RFS_QTDE) '@RFS_QTDE'
			-- 
			-- 		SELECT (ABS(@RFS_QTDE) * @PU_JUROS_PGTO_DIA) 'JUROS_PAGOS'
			-- DESCONTAR JUROS PAGOS NO DIA ANTERIOR
			-- KUBA - 21/11/2016 - 
			--SELECT @RFS_JUROS_ANT = @RFS_JUROS_ANT - (ABS(@RFS_QTDE) * @PU_JUROS_PGTO_DIA)
			SELECT @RFS_JUROS_ANT = @RFS_JUROS

			--		SELECT @RFS_JUROS_ANT '@RFS_JUROS_ANT - DEPOIS', @DT_CALC '@DT_CALC'
			SELECT @DT_CALC = DATEADD(day, 1, @DT_CALC)
				,@RFS_PU_UTEIS_ANT = @RFS_PU_UTEIS
				,@RFS_PU_MERC_ANT = @RFS_PU_MERCADO
				,@RFS_IR_ANT = @RFS_IR
				,@PRINCIPAL_ABERTURA = @RFS_PRINCIPAL
				,@DT_AQUIS_ANT = @DT_AQUIS

			SELECT @RFS_QTDE = @QTDE_SALDO

			IF @V_PRIM_CALCULO = 'S'
				AND @V_SEGU_CALCULO = 'N'
			BEGIN
				SELECT @V_PRIM_CALCULO = 'N'
					,@V_SEGU_CALCULO = 'S'
			END
			ELSE
			BEGIN
				SELECT @V_PRIM_CALCULO = 'N'
					,@V_SEGU_CALCULO = 'N'
			END
					-- 20/05/2019 - MARCIO
					-- PARTE FINAL DA TRANSFERENCIA DE CUSTODIA, NÃO É O PRIMEIRO DIA, NEM TÃO POUCO OS ULTIMOS X DIAS, 
					-- ENTÃO ELE APENAS COPIA O REGISTRO DO PRIMEIRO CALCULO 
		END
		ELSE
		BEGIN
			INSERT INTO RF_SALDOS (
				RF_CARACTERISTICA
				,RFS_DATA
				,RFS_QTDE
				,RFS_QTDE_C
				,RFS_QTDE_V
				,RFS_FIN_C
				,RFS_FIN_V
				,RFS_PRINCIPAL
				,RFS_TAXA_MEDIA
				,RFS_PU_CUSTO
				,RFS_PU_MERCADO
				,RFS_PU_MERC_ANT
				,RFS_RESULTADO
				,RFS_IOF
				,RFS_IR
				,RFS_IR_ANT
				,RFS_JUROS
				,RFS_JUROS_ANT
				,RFS_CORRECAO
				,RFS_CORRECAO_ANT
				,LC_SITUACAO
				,PGT_JUROS
				,RFS_TAXA_MEDIA_U
				,RFS_APROPRIAR
				,RFS_APROPRIAR_ANT
				,IR_ABERTURA
				,PRINCIPAL_ABERTURA
				,rfs_correcao_acru
				,RFS_AGDG_C
				,RFS_AGDG_U
				,rfs_agdg
				,rfs_agdg_ant
				,RFS_IOFR
				,RFS_PROVISAO_ANT
				,RFS_PROVISAO_DIF
				,RFS_PROVISAO
				,RFS_PROVISAO_TRANSF
				,V_JURS_CTBL
				,V_CORC_CTBL
				,V_JURS_CTBL_ANTR
				,V_CORC_CTBL_ANTR
				,V_FATR_ACUD_UTES
				,V_FATR_ACUD_MERC
				,V_PU_CTBL
				,PDD_FXA_SEQ
				,V_PDD
				,V_PZ_MDIO_CALD
				,V_PZ_MDIO_AJTD
				,RFS_PU_UTEIS
				,RFS_PU_CORRIDOS
				,V_DURT_CALD
				,V_PU_NEGC
				)
			SELECT TOP 1 @RF_CARACTERISTICA
				,@DT_CALC
				,--  RFS_QTDE           ,
				CASE 
					WHEN @V_SEGU_CALCULO = 'S'
						THEN RFS_QTDE_C
					ELSE RFS_QTDE
					END AS RFS_QTDE
				,CASE 
					WHEN @V_SEGU_CALCULO = 'S'
						THEN 0
					ELSE RFS_QTDE_C
					END AS RFS_QTDE_C
				,
				-- RFS_QTDE_C          ,	
				RFS_QTDE_V
				,CASE 
					WHEN @V_SEGU_CALCULO = 'S'
						THEN 0
					ELSE RFS_FIN_C
					END AS RFS_FIN_C 				-- ,RFS_FIN_C
				,RFS_FIN_V
				,RFS_PRINCIPAL
				,RFS_TAXA_MEDIA
				,RFS_PU_CUSTO
				,RFS_PU_MERCADO
				,RFS_PU_MERC_ANT
				,RFS_RESULTADO
				,RFS_IOF
				,RFS_IR
				,RFS_IR_ANT
				,RFS_JUROS
				,RFS_JUROS_ANT
				,RFS_CORRECAO
				,RFS_CORRECAO_ANT
				,LC_SITUACAO
				,PGT_JUROS
				,RFS_TAXA_MEDIA_U
				,RFS_APROPRIAR
				,RFS_APROPRIAR_ANT
				,IR_ABERTURA
				,PRINCIPAL_ABERTURA
				,rfs_correcao_acru
				,RFS_AGDG_C
				,RFS_AGDG_U
				,rfs_agdg
				,rfs_agdg_ant
				,RFS_IOFR
				,RFS_PROVISAO_ANT
				,RFS_PROVISAO_DIF
				,RFS_PROVISAO
				,RFS_PROVISAO_TRANSF
				,V_JURS_CTBL
				,V_CORC_CTBL
				,V_JURS_CTBL_ANTR
				,V_CORC_CTBL_ANTR
				,V_FATR_ACUD_UTES
				,V_FATR_ACUD_MERC
				,V_PU_CTBL
				,PDD_FXA_SEQ
				,V_PDD
				,V_PZ_MDIO_CALD
				,V_PZ_MDIO_AJTD
				,RFS_PU_UTEIS
				,RFS_PU_CORRIDOS
				,V_DURT_CALD
				,V_PU_NEGC
			FROM RF_SALDOS
			WHERE RF_CARACTERISTICA = @RF_CARACTERISTICA
				AND RFS_DATA = @DT_CALC_INI

			SELECT @DT_CALC = DATEADD(day, 1, @DT_CALC)
		END
	END

	-- SE NAO POSSUIA CENARIO EM ALGUMA DATA, MAS O NAO CONTABILIZAVA PELA CURVA MERCADO EXIBE A MENSAGEM
	IF @DT_ACABOU_CEN IS NOT NULL
		AND @EH_FUNDO = 'S'
		AND EXISTS (
			SELECT IC_APC
			FROM SANT269_RF_CENARIO_MOS A(NOLOCK)
				,SANT447_GE_CEN_SAN_APC B(NOLOCK)
			WHERE A.SGL_MEDA = B.SGL_MEDA
				AND B.IDX_CODIGO = @SGL_MEDA
				AND A.IC_APC = 'S'
			)
	BEGIN
		SELECT @ERR_MSG = @RF_CARACTERISTICA + ': NAO EXISTE O CENARIO: ' + RTRIM(@SGL_MEDA) + ' - A PARTIR DE: ' + CONVERT(CHAR(10), @DT_ACABOU_CEN, 103) + '. CURVA MERCADO = APROPRIACAO.'

		IF @RETORNA_MSG <> 'S'
			RAISERROR 70001 @ERR_MSG
		ELSE
			SELECT @MENSAGEM_ERRO = @ERR_MSG

		RETURN
	END

	SET NOCOUNT OFF
END


